<div class='bg-trang' xmlns='http://www.w3.org/1999/html'>
  <div class='header header-green-background'>
    <div class='header-text'>
      <div class='title-chi-tieu'>
        <span [ngClass]="formData.value.trangThai == STATUS.BAN_HANH ? 'da-ban-hanh' : 'du-thao-va-lanh-dao-duyet'">
          {{ formData.value.tenTrangThai }}
        </span>
        <span class='text-uppercase'>Định mức phí nhập xuất bảo quản {{capDvi == 1 ? 'tổng cục' : 'cục'}} giao</span>
      </div>
    </div>
    <nz-alert *ngIf='formData.value.trangThai == STATUS.TU_CHOI_LDV ' nzShowIcon nzType='error'
              nzMessage='Lý do từ chối'
              nzDescription='{{formData.value.lyDoTuChoi}}'>
    </nz-alert>
    <div class='btn-group'>
      <button type='button' class='btn btn-sub' (click)='quayLai(capDvi)'>
        <i class='fa fa-arrow-left'></i>
        <span>Quay lại</span>
      </button>
      <button type='button' class='btn btn-info ml-2' (click)='banHanh(formData.value.id,STATUS.BAN_HANH)'
              *ngIf='formData.value.trangThai == STATUS.DU_THAO && formData.value.id > 0'>
        <i class='icon htvbdh_chuyenvanthu'></i>
        <span>Ban hành</span>
      </button>
      <button type='button' class='btn btn-outline-danger ml-2'
              (click)='ngungHieuLuc(formData.value.id,STATUS.HET_HIEU_LUC)'
              *ngIf='formData.value.trangThai == STATUS.BAN_HANH && formData.value.id > 0'>
        <i class='icon htvbdh_chuyenvanthu'></i>
        <span>Ngừng hiệu lực văn bản </span>
      </button>
      <button *ngIf='!isViewDetail'
              type='button' class='btn btn-main ml-2' (click)='save()'>
        <i class='icon htvbdh_tcdt_save'></i>
        <span>Lưu</span>
      </button>
    </div>
  </div>
  <nz-card class='mg-t-16 flex-card p-lr16 mt-5'>
    <form nz-form nzLayout='vertical' [formGroup]='formData'>
      <div nz-row [nzGutter]='[24]'>
        <div nz-col nzSpan='4'>
          <nz-form-item>
            <nz-form-control [nzErrorTip]='error'>
              <nz-form-label nzRequired [nzNoColon]='true' class='label-color-kh'> Số quyết định</nz-form-label>
              <input nz-input formControlName='soQd' [readonly]='isViewDetail' />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan='11'>
          <nz-form-item>
            <nz-form-control [nzErrorTip]='error'>
              <nz-form-label nzRequired [nzNoColon]='true' class='label-color-kh'> Trích yếu</nz-form-label>
              <input nz-input formControlName='trichYeu' [readonly]='isViewDetail' />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan='3'>
          <nz-form-label [nzNoColon]='true' nzRequired class='label-color-kh'> Ngày ký QĐ
          </nz-form-label>
          <nz-form-control [nzErrorTip]='error'>
            <nz-date-picker class='search__input' nzFormat='dd/MM/yyyy'
                            formControlName='ngayKy' nzPlaceHolder='Ngày ký'
                            [nzDisabled]='isViewDetail'>
            </nz-date-picker>
          </nz-form-control>
        </div>
        <div nz-col nzSpan='3'>
          <nz-form-label [nzNoColon]='true' nzRequired class='label-color-kh'> Ngày hiệu lực
          </nz-form-label>
          <nz-form-control [nzErrorTip]='error'>
            <nz-date-picker class='search__input' nzFormat='dd/MM/yyyy'
                            formControlName='ngayHieuLuc' nzPlaceHolder='Ngày hiệu lực'
                            [nzDisabled]='isViewDetail'>
            </nz-date-picker>
          </nz-form-control>
        </div>
        <div nz-col nzSpan='3' *ngIf='formData.value.trangThai == STATUS.HET_HIEU_LUC'>
          <nz-form-label [nzNoColon]='true' class='label-color-kh'> Ngày hết hiệu lực
          </nz-form-label>
          <nz-form-control [nzErrorTip]='error'>
            <nz-date-picker class='search__input' nzFormat='dd/MM/yyyy'
                            formControlName='ngayHetHieuLuc'
                            [nzDisabled]='isViewDetail'>
            </nz-date-picker>
          </nz-form-control>
        </div>
        <div nz-col [nzSpan]='24'>
          <nz-form-item class='form-item'>
            <nz-form-label [nzNoColon]='true' class='label-color-kh'> Tài liệu đính kèm</nz-form-label>
            <div class='list-file'>
              <file-list [disabled]='isViewDetail' [data]='fileDinhKem'></file-list>
            </div>
          </nz-form-item>
        </div>
      </div>
    </form>
    <ng-template #error let-control>
      <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
      </ng-container>
    </ng-template>
  </nz-card>
  <div style='height: 30px'></div>
  <nz-card class='mt-2px flex-card data-table card-border-content table-card'>
    <nz-table #basicTable [nzFrontPagination]='false' [nzShowPagination]='false'
              [nzData]='dataTableDetail' [nzScroll]="{ x: '1600px' }"
              nzBordered>
      <thead>
      <tr>
        <th rowspan='3'>STT</th>
        <th rowspan='3' width='100px'>Mã định mức</th>
        <th rowspan='3' width='100px'>Tên định mức</th>
        <th rowspan='3' width='200px'>Áp dụng tại {{capDvi == 1 ? 'cục' : 'chi cục'}}</th>
        <th rowspan='3' [nzWidth]="'150px'">Đơn vị tính</th>
        <th rowspan='3' width='150px' *ngIf='capDvi == 2'>Tổng định mức theo <br /> QĐ của TCDT</th>
        <th rowspan='3' width='150px'>Tổng định mức</th>
        <th rowspan='3' width='150px' *ngIf='capDvi == 2'>Tổng định mức chi <br /> tại Cục DTNN KV</th>
        <th colspan='5' width='680px'>Mức chi giao văn phòng {{capDvi == 1 ? 'Tổng cục' : 'cục'}}</th>
        <th colspan='5'
            width='680px'>{{capDvi == 1 ? 'Mức chi giao cục DTNN KV' : 'Mức chi giao Chi cục DTNN trực thuộc'}}</th>
        <th rowspan='3' width='200px' *ngIf='capDvi == 2'>Tổng cục điều hành <br /> (Nghiệp vụ chuyên môn)</th>
        <th rowspan='3' width='100px' *ngIf='!isViewDetail'>Hành động</th>
      </tr>
      <tr>
        <th rowspan='2' width='80px'>Tổng cộng</th>
        <th colspan='3' width='480px'>Văn phòng chủ động</th>
        <th rowspan='2' width='120px'>{{capDvi == 1 ? 'Tổng cục' : 'Cục'}} điều hành</th>
        <th rowspan='2' width='80px'>Tổng cộng</th>
        <th colspan='3' width='480px'>{{capDvi == 1 ? 'Cục' : 'Chi cục'}} chủ động thực hiện</th>
        <th rowspan='2' width='120px'>{{capDvi == 1 ? 'Tổng cục' : 'Cục'}} điều hành</th>
      </tr>
      <tr>
        <th width='80px'>Cộng</th>
        <th width='200px'>NV chuyên môn</th>
        <th width='200px'>Thanh toán cá nhân</th>
        <th width='80px'>Cộng</th>
        <th width='200px'>NV chuyên môn</th>
        <th width='200px'>Thanh toán cá nhân</th>
      </tr>
      <tr>
        <th></th>
        <th>
          <nz-select [(ngModel)]='rowItem.maDinhMuc' [nzDisabled]='isViewDetail' (ngModelChange)="changeDm('ma')"
                     nzAllowClear='true'>
            <nz-option *ngFor='let p of listDmDinhMuc' [nzValue]='p.maDinhMuc' [nzLabel]='p.maDinhMuc'>
            </nz-option>
            <ng-template #error let-control>
              <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
              </ng-container>
            </ng-template>
          </nz-select>
        </th>
        <th>
          <nz-select [(ngModel)]='rowItem.tenDinhMuc' [nzDisabled]='isViewDetail' (ngModelChange)="changeDm('ten')"
                     (ngModelChange)='updateAllChecked()' nzAllowClear='true'>
            <nz-option *ngFor='let p of listDmDinhMuc' [nzValue]='p.tenDinhMuc' [nzLabel]='p.tenDinhMuc'>
            </nz-option>
            <ng-template #error let-control>
              <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
              </ng-container>
            </ng-template>
          </nz-select>
        </th>
        <th>
          <nz-select
            nzMode='multiple'
            style='width:180px'
            nzPlaceHolder='Chọn đơn vị áp dụng'
            nzAllowClear
            [(ngModel)]=rowItem.apDungTai>
            <nz-option *ngFor='let option of listDonVi' [nzValue]='option.maDvi'
                       [nzLabel]='option.tenDvi'></nz-option>
          </nz-select>
        </th>
        <th>
          <input type='text' [disabled]='true' [(ngModel)]='rowItem.donViTinh' nz-input />
        </th>
        <th *ngIf='capDvi == 2'>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.tongDinhMucTc'
                 nz-input />
        </th>
        <th>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc + rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv + rowItem.tcTongCucDieuHanhKv'
                 nz-input />
        </th>
        <th *ngIf='capDvi == 2'>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc  + rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv'
                 nz-input />
        </th>
        <th>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc' nz-input />
        </th>
        <th>
          <input type='text' [disabled]='true' [(ngModel)]='rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc' nz-input />
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.nvChuyenMonTc' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.nvChuyenMonTc' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc + rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.ttCaNhanTc' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.ttCaNhanTc' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.nvChuyenMonTc + rowItem.tcDieuHanhTc + rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.tcDieuHanhTc' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.tcDieuHanhTc' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv ' nz-input />
        </th>
        <th>
          <input type='text' [disabled]='true' [(ngModel)]='rowItem.nvChuyenMonKv + rowItem.ttCaNhanKv ' nz-input />
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.nvChuyenMonKv' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.nvChuyenMonKv' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc + rowItem.ttCaNhanKv + rowItem.tcDieuHanhKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.ttCaNhanKv' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.ttCaNhanKv' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc + rowItem.tcDieuHanhTc + rowItem.tcDieuHanhKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 1'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.tcDieuHanhKv' [nzFormatter]='globals.formatter'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <nz-input-number [nzSize]="'small'" [(ngModel)]='rowItem.tcDieuHanhKv' [nzFormatter]='globals.formatter'
                           [nzMax]='rowItem.tongDinhMucTc > (rowItem.nvChuyenMonTc + rowItem.ttCaNhanTc + rowItem.tcDieuHanhTc + rowItem.tcDieuHanhTc + rowItem.ttCaNhanKv) ? rowItem.tongDinhMucTc : 0'
                           [nzParser]='globals.parser'>
          </nz-input-number>
        </th>
        <th *ngIf='capDvi == 2'>
          <input type='text' [disabled]='true'
                 [(ngModel)]='rowItem.tcTongCucDieuHanhKv'
                 nz-input />
        </th>
        <th class='text-center' *ngIf='!isViewDetail'>
          <a (click)='addDetailDinhMuc()' [ngClass]="{'isDisabled' : !isAddDetail}">
            <i class='icon htvbdh_dau-cong'></i>
          </a>
          <a>
            <i class='fa fa-refresh'></i>
          </a>
        </th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor='let data of dataTableDetail; let idx = index'>
        <ng-container *ngIf='(dataEdit && dataEdit[idx] && !dataEdit[idx].edit); else editTemplate'>
          <td>{{idx + 1}}</td>
          <td>{{data.maDinhMuc}}</td>
          <td>{{data.tenDinhMuc}}</td>
          <td>{{data.apDungTai ? data.apDungTaiStr : 'Tất cả '}}</td>
          <td>{{data.donViTinh}}</td>
          <td *ngIf='capDvi == 2'>{{data.tongDinhMucTc}}</td>
          <td>{{(data.nvChuyenMonTc + data.ttCaNhanTc + data.tcDieuHanhTc + data.nvChuyenMonKv + data.ttCaNhanKv + data.tcDieuHanhKv) | number : '1.0-1' : 'vi_VN'}}</td>
          <td
            *ngIf='capDvi == 2'>{{(data.nvChuyenMonTc + data.ttCaNhanTc + data.nvChuyenMonKv + data.ttCaNhanKv) | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{(data.nvChuyenMonTc + data.ttCaNhanTc + data.tcDieuHanhTc) | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{(data.nvChuyenMonTc + data.ttCaNhanTc)| number : '1.0-1' : 'vi_VN' }}</td>
          <td>{{data.nvChuyenMonTc | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.ttCaNhanTc | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.tcDieuHanhTc | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.nvChuyenMonKv + data.ttCaNhanKv + data.tcDieuHanhKv | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.nvChuyenMonKv + data.ttCaNhanKv  | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.nvChuyenMonKv | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.ttCaNhanKv | number : '1.0-1' : 'vi_VN'}}</td>
          <td>{{data.tcDieuHanhKv | number : '1.0-1' : 'vi_VN'}}</td>
          <td *ngIf='capDvi == 2'>{{data.tcTongCucDieuHanhKv | number : '1.0-1' : 'vi_VN'}}</td>
          <td *ngIf='!isViewDetail'>
            <a (click)='editRow(idx)'>
              <i class='fa fa-pencil' title='Sửa'></i>
            </a>
            <a (click)='deleteItem(idx)'>
              <i class='fa fa-trash-o do' title='Xóa bản ghi'></i>
            </a>
          </td>
        </ng-container>
        <ng-template #editTemplate>
          <td></td>
          <td>
            {{dataEdit[idx].data.maDinhMuc}}
          </td>
          <td>
            {{dataEdit[idx].data.tenDinhMuc}}
          </td>
          <td>
            {{dataEdit[idx].data.apDungTai ? dataEdit[idx].data.apDungTai : 'Tất cả '}}
          </td>
          <td>
            <input type='text' [disabled]='true' [(ngModel)]='dataEdit[idx].data.donViTinh' nz-input />
          </td>
          <td>
            <input type='text' [disabled]='true'
                   [(ngModel)]='dataEdit[idx].data.nvChuyenMonTc + dataEdit[idx].data.ttCaNhanTc + dataEdit[idx].data.tcDieuHanhTc + dataEdit[idx].data.nvChuyenMonKv + dataEdit[idx].data.ttCaNhanKv + dataEdit[idx].data.tcDieuHanhKv'
                   nz-input />
          </td>
          <td>
            <input type='text' [disabled]='true'
                   [(ngModel)]='dataEdit[idx].data.nvChuyenMonTc + dataEdit[idx].data.ttCaNhanTc + dataEdit[idx].data.tcDieuHanhTc'
                   nz-input />
          </td>
          <td>
            <input type='text' [disabled]='true'
                   [(ngModel)]='dataEdit[idx].data.nvChuyenMonTc + dataEdit[idx].data.ttCaNhanTc ' nz-input />
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.nvChuyenMonTc'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.ttCaNhanTc'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.tcDieuHanhTc'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <input type='text' [disabled]='true'
                   [(ngModel)]='dataEdit[idx].data.nvChuyenMonKv + dataEdit[idx].data.ttCaNhanKv + dataEdit[idx].data.tcDieuHanhKv '
                   nz-input />
          </td>
          <td>
            <input type='text' [disabled]='true'
                   [(ngModel)]='dataEdit[idx].data.nvChuyenMonKv + dataEdit[idx].data.ttCaNhanKv ' nz-input />
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.nvChuyenMonKv'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.ttCaNhanKv'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <nz-input-number [nzSize]="'small'" [(ngModel)]='dataEdit[idx].data.tcDieuHanhKv'
                             [nzFormatter]='globals.formatter'
                             [nzParser]='globals.parser'>
            </nz-input-number>
          </td>
          <td>
            <a class='save' (click)='saveDinhMuc(idx)'>
              <i class='fa fa-save'></i>
            </a>
            <a (click)='cancelEdit(idx)'>
              <i class='fa fa-ban do'></i> </a>
          </td>
        </ng-template>


      </tr>
      </tbody>
    </nz-table>
    <div class='tab-content tab-menu'>
      <div class='tab-pane fade show active justify-content-between'>
        <div class='trai'></div>
        <div class='canphai'>
          <!-- begin phân trang  -->
          <nz-pagination class='pagination-card' [nzPageIndex]='page' [nzTotal]='totalRecord' nzShowSizeChanger
                         [nzPageSize]='pageSize' [nzShowTotal]='rangeTemplate'
                         (nzPageIndexChange)='changePageIndex($event)'
                         (nzPageSizeChange)='changePageSize($event)'>
            <ng-template #rangeTemplate let-range='range' let-total>
              {{ range[0] }}-{{ range[1] }} trên tổng số {{ total }} bản ghi
            </ng-template>
          </nz-pagination>
          <!-- end phân trang  -->
        </div>
      </div>
    </div>
  </nz-card>
</div>

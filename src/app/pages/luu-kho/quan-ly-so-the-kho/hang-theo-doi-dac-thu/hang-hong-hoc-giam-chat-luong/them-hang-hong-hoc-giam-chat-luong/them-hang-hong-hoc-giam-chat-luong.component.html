<nz-affix class="menu-lv2 dieu-chinh-button" [nzOffsetTop]="globals.prop.MENU_LV2">
  <div class="tab-content tab-menu" >
    <div class="d-flex justify-content-between header-tab" id="banhanh">
      <div class="trai">
      </div>
      <div class="canphai phai">
        <button type="button" class="btn btn-sub" (click)="quayLai()">
          <i class="fa fa-arrow-left"></i>
          <span>Quay lại</span>
        </button>
        <button  type="button" class="btn btn-sub xanh"
                 (click)="luu()">
          <i class="icon htvbdh_luu"></i>
          <span>Lưu</span>
        </button>
      </div>
    </div>
  </div>
</nz-affix>

<div class="bg-trang">
  <nz-card class="mt16 flex-card p-lr16">
    <div class="header">
      <div class="header-text">
        <div class="title-chi-tieu">
                     <span
                       [ngClass]="formData.value.trangThai == globals.prop.NHAP_DA_TONG_HOP ? 'da-ban-hanh' : 'du-thao-va-lanh-dao-duyet'">
        {{ formData.value.tenTrangThai }}
      </span>
          <span>Hàng hỏng hóc,giảm chất lượng do nguyên nhân bất khả kháng</span>
        </div>
      </div>
    </div>
    <form [nzLayout]="'vertical'" nz-form [formGroup]="formData" class="hang-theo-doi-dac-thu">
      <div nz-row [nzGutter]="[16, 12]">
        <div nz-col nzSpan="4">
        <nz-form-item nz-col  class="form-item">
          <nz-form-label nzFor="loai-hang-hoa">Chi cục DTNN KV</nz-form-label>
          <nz-form-control >
            <nz-input-group>
              <input type="text " nz-input formControlName="tenDvi" [readonly]="true">
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        </div>
        <div nz-col nzSpan="4" >
          <nz-form-item nz-col class="form-item">
            <nz-form-label nzFor="ngay-tao">Ngày tạo danh sách</nz-form-label>
            <nz-form-control >
              <nz-date-picker [nzDisabled]="true" formControlName="ngayDeXuat" nzFormat="dd/MM/yyyy" id="ngay-tao" class="search__input">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>

      </div>
    </form>

  </nz-card>
  <nz-card class="mt-16 flex-card data-table card-border-content">
    <div class="group-button">
      <h3>Danh sách hàng hỏng, giảm chất lượng do nguyên nhân bất khả kháng</h3>
      <div class="buttons">
        <button type="button" class="btn btn-sub" (click)="exportData(idInput)">
          <i class="icon htvbdh_chuyen-xu-ly"></i>
          <span>Xuất file</span>
        </button>
      </div>
    </div>
    <nz-table #editRowTable [nzData]="dataTable" [nzFrontPagination]="false" [nzShowPagination]="false" nzBordered [nzScroll]=
      "{ x: '2200px' }">
      <thead>
      <tr>
        <th class="text-center" style="width: 5%;">STT</th>
        <th style="width: 16%;">Loại hàng hoá</th>
        <th style="width: 15%;">Chủng loại hàng hoá</th>
        <th style="width: 15%;">Tên hàng hoá</th>
        <th style="width: 15%;">Điểm kho</th>
        <th style="width: 15%;">Nhà kho</th>
        <th style="width: 15%;">Ngăn kho</th>
        <th style="width: 15%;">Lô kho</th>
        <th style="width: 10%;">SL tồn</th>
        <th style="width: 10%;">SL hỏng cần SC</th>
        <th style="width: 10%;">SL SC đã duyệt</th>
        <th style="width: 10%;">SL còn lại cần SC </th>
        <th style="width: 8%;">Đơn vị tính</th>
        <th style="width: 30%;">Lý do</th>
        <th style="width: 10%; text-align: center"  nzRight>Hành động</th>
      </tr>
      <tr>
        <th></th>
        <th>
          <nz-form-control>
            <nz-select  [(ngModel)]="rowItem.loaiVthh" (ngModelChange)="changeLoaiHangHoa($event)">
              <nz-option *ngFor="let item of dsLoaiHangHoa" nzValue="{{item.ma}}" nzLabel="{{item.ten}}">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </th>
        <th>
          <nz-form-control>
            <nz-select [(ngModel)]="rowItem.cloaiVthh" (ngModelChange)="changeCloaiHangHoa($event)">
              <nz-option *ngFor="let item of listChungLoaiHangHoa" nzValue="{{item.ma}}" nzLabel="{{item.ten}}">
              </nz-option>
            </nz-select>
          </nz-form-control>
        </th>
        <th>
          <nz-input-group>
            <input type="text" [(ngModel)]="rowItem.moTaHangHoa" nz-input placeholder="Nhập tên hàng hoá" />
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <nz-select [(ngModel)]="rowItem.maDiemKho" placeholder="Nhập điểm kho" (ngModelChange)="onChangeDiemKho($event)">
              <nz-option nzValue="null" nzDisabled nzHide></nz-option>
              <nz-option nzValue="{{item.maDvi}}" nzLabel="{{item.tenDvi}}" *ngFor="let item of dsDiemKho">
              </nz-option>
            </nz-select>
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <nz-select [(ngModel)]="rowItem.maNhaKho" placeholder="Nhập nhà kho" (ngModelChange)="onChangeNhaKho($event)">
              <nz-option nzValue="null" nzDisabled nzHide></nz-option>
              <nz-option *ngFor="let p of dsNhaKho" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
              </nz-option>
            </nz-select>
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <nz-select [(ngModel)]="rowItem.maNganKho" placeholder="Nhập nhà kho" (ngModelChange)="onChangeNganKho($event)">
              <nz-option nzValue="null" nzDisabled nzHide></nz-option>
              <nz-option *ngFor="let p of dsNganLo" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
              </nz-option>
            </nz-select>
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <nz-select [(ngModel)]="rowItem.maLoKho" placeholder="Nhập ngăn lô" (ngModelChange)="onChangLoKho($event)">
              <nz-option nzValue="null" nzDisabled nzHide></nz-option>
              <nz-option *ngFor="let p of dsLoKho" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
              </nz-option>
            </nz-select>
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="number" [(ngModel)]="rowItem.slTon" nz-input placeholder="Nhập số lượng" />
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="number" [(ngModel)]="rowItem.slYeuCau" nz-input placeholder="Nhập số lượng" />
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="number" [(ngModel)]="rowItem.slDaDuyet" nz-input placeholder="Nhập số lượng" />
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="number" [readonly]="true" [(ngModel)]="rowItem.slYeuCau - rowItem.slDaDuyet" nz-input placeholder="Nhập số lượng" />
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="text" [(ngModel)]="rowItem.dviTinh" nz-input [readonly]="true"/>
          </nz-input-group>
        </th>
        <th>
          <nz-input-group>
            <input type="text" [(ngModel)]="rowItem.lyDo" nz-input placeholder="Nhập lý do" />
          </nz-input-group>
        </th>
        <th style="text-align: center;" nzRight>
          <a (click)="themMoiItem()">
            <i class="table-icon icon htvbdh_dau-cong"></i>
          </a>
          <a (click)="clearData()">
            <i class="table-icon icon  htvbdh_nhap-lai1"></i>
          </a>
        </th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let data of editRowTable.data; let idx = index">
        <ng-container *ngIf="!dataEdit[idx].edit; else editTemplate">
          <td>{{ idx + 1 }}</td>
          <td>{{ data.tenLoaiVthh}}</td>
          <td>{{ data.tenCloaiVthh}}</td>
          <td>{{ data.moTaHangHoa}}</td>
          <td>{{ data.tenDiemKho}}</td>
          <td>{{ data.tenNhaKho}}</td>
          <td>{{ data.tenNganKho}}</td>
          <td>{{ data.tenLoKho }}</td>
          <td>{{ data.slTon }}</td>
          <td>{{ data.slYeuCau }}</td>
          <td>{{ data.slDaDuyet }}</td>
          <td>{{ data.slYeuCau - data.slDaDuyet }}</td>
          <td>{{ data.dviTinh }}</td>
          <td>{{ data.lyDo }}</td>
          <td style="text-align: center;" nzRight>
            <a (click)="editItem(idx)">
              <i class="table-icon fa fa-pencil"></i>
            </a>
            <a (click)="xoaItem(idx)">
              <i class="table-icon fa fa-trash-o do"></i>
            </a>
          </td>
        </ng-container>
        <ng-template #editTemplate>
          <th></th>
          <th>
            <nz-form-control>
              <nz-select  [(ngModel)]="dataEdit[idx].data.loaiVthh" (ngModelChange)="changeLoaiHangHoa($event, dataEdit[idx].data)">
                <nz-option *ngFor="let item of dsLoaiHangHoa" nzValue="{{item.ma}}" nzLabel="{{item.ten}}">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </th>
          <th>
            <nz-form-control>
              <nz-select [(ngModel)]="dataEdit[idx].data.cloaiVthh" (ngModelChange)="changeCloaiHangHoa($event,dataEdit[idx].data )">
                <nz-option *ngFor="let item of listChungLoaiHangHoa" nzValue="{{item.ma}}" nzLabel="{{item.ten}}">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </th>
          <th>
            <nz-input-group>
              <input type="text" [(ngModel)]="dataEdit[idx].data.moTaHangHoa" nz-input placeholder="Nhập tên hàng hoá" />
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <nz-select [(ngModel)]="dataEdit[idx].data.maDiemKho" placeholder="Nhập điểm kho" (ngModelChange)="onChangeDiemKho($event, dataEdit[idx].data)">
                <nz-option nzValue="null" nzDisabled nzHide></nz-option>
                <nz-option nzValue="{{item.maDvi}}" nzLabel="{{item.tenDvi}}" *ngFor="let item of dsDiemKho">
                </nz-option>
              </nz-select>
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <nz-select [(ngModel)]="dataEdit[idx].data.maNhaKho" placeholder="Nhập nhà kho" (ngModelChange)="onChangeNhaKho($event, dataEdit[idx].data)">
                <nz-option nzValue="null" nzDisabled nzHide></nz-option>
                <nz-option *ngFor="let p of dsNhaKho" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
                </nz-option>
              </nz-select>
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <nz-select [(ngModel)]="dataEdit[idx].data.maNganKho" placeholder="Nhập nhà kho" (ngModelChange)="onChangeNganKho($event, dataEdit[idx].data)">
                <nz-option nzValue="null" nzDisabled nzHide></nz-option>
                <nz-option *ngFor="let p of dsNganLo" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
                </nz-option>
              </nz-select>
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <nz-select [(ngModel)]="dataEdit[idx].data.maLoKho" placeholder="Nhập ngăn lô" (ngModelChange)="onChangLoKho($event, dataEdit[idx].data )">
                <nz-option nzValue="null" nzDisabled nzHide></nz-option>
                <nz-option *ngFor="let p of dsLoKho" [nzValue]="p.maDvi" [nzLabel]="p.tenDvi">
                </nz-option>
              </nz-select>
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="number" [(ngModel)]="dataEdit[idx].data.slTon" nz-input placeholder="Nhập số lượng" />
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="number" [(ngModel)]="dataEdit[idx].data.slYeuCau" nz-input placeholder="Nhập số lượng" />
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="number" [(ngModel)]="dataEdit[idx].data.slDaDuyet" nz-input placeholder="Nhập số lượng" />
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="number" [(ngModel)]="dataEdit[idx].data.slConLai" nz-input placeholder="Nhập số lượng" />
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="text" [(ngModel)]="dataEdit[idx].data.dviTinh" nz-input [readonly]="true"/>
            </nz-input-group>
          </th>
          <th>
            <nz-input-group>
              <input type="text" [(ngModel)]="dataEdit[idx].data.lyDo" nz-input placeholder="Nhập lý do" />
            </nz-input-group>
          </th>
          <td style="text-align: center;" nzRight>
            <a (click)="luuEdit(idx)" class="save">
              <i class="fa fa-save"></i>
            </a>
            <a (click)="huyEdit(idx)">
              <i class="fa fa-times do"></i>
            </a>
          </td>
        </ng-template>
      </tr>
      </tbody>
    </nz-table>
    <div class="tab-content tab-menu" id="myTabContent">
      <div class="tab-pane fade show active justify-content-between">
        <div class="trai">

        </div>
        <div class="canphai">
          <nz-pagination class="pagination-card" [nzPageIndex]="page" [nzTotal]="totalRecord" nzShowSizeChanger
                         [nzPageSize]="pageSize" [nzShowTotal]="rangeTemplate" (nzPageIndexChange)="changePageIndex($event)"
                         (nzPageSizeChange)="changePageSize($event)">
            <ng-template #rangeTemplate let-range="range" let-total>
              {{ range[0] }}-{{ range[1] }} trên tổng số {{ total }} bản ghi
            </ng-template>
          </nz-pagination>
        </div>
      </div>
    </div>
  </nz-card>
</div>

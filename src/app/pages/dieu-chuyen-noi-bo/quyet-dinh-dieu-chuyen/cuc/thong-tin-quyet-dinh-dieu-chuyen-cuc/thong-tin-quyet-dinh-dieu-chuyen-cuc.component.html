<div class="bg-trang">
  <div class="header header-green-background">
    <div class="header-text">
      <div class="title-chi-tieu">
        <span [ngClass]="'da-ban-hanh'">
          {{ formData.value.tenTrangThai }}
        </span>
        <span *ngIf="isTongCuc()"> QUYẾT ĐỊNH PHÊ DUYỆT ĐIỀU CHUYỂN NỘI BỘ HÀNG DTQG CỦA TỔNG CỤC DTNN</span>
        <span *ngIf="isCuc()"> QUYẾT ĐỊNH ĐIỀU CHUYỂN NỘI BỘ HÀNG DTQG CỦA CỤC DTNN KHU VỰC</span>
      </div>
    </div>

    <div class="btn-group">

      <button type="button" class="btn btn-sub" (click)="quayLai()">
        <i class="fa fa-arrow-left"></i>
        <span>Quay lại</span>
      </button>
      <button *ngIf="!isView && formData.value.trangThai == STATUS.DU_THAO" type="button"
        class="btn btn-sub xanh-nhat ml-2" (click)="save(true)">
        <i class="icon htvbdh_tcdt_guiduyet"></i>
        <span>Lưu và gửi duyệt</span>
      </button>
      <button *ngIf="!isView" type="button" class="btn btn-main ml-2" (click)="save()">
        <i class="icon htvbdh_tcdt_save"></i>
        <span>Lưu</span>
      </button>

      <button
        *ngIf="formData.value.trangThai == STATUS.CHO_DUYET_TP || formData.value.trangThai == STATUS.TU_CHOI_TP || formData.value.trangThai == STATUS.CHO_DUYET_LDC || formData.value.trangThai == STATUS.TU_CHOI_LDC"
        type="button" class="btn btn-sub" (click)="tuChoi()">
        <i class="icon htvbdh_tcdt_tuchoi do"></i>
        <span>Từ chối</span>
      </button>

      <button *ngIf="formData.value.trangThai == STATUS.CHO_DUYET_TP" type="button" class="btn btn-sub"
        (click)="pheDuyet()">
        <i class="icon htvbdh_tcdt_pheduyet"></i>
        <span>Duyệt</span>
      </button>

      <button *ngIf="formData.value.trangThai == STATUS.CHO_DUYET_LDC" type="button" class="btn btn-info ml-2"
        (click)="banHanh()">
        <i class="icon htvbdh_chuyenvanthu"></i>
        <span>Ban hành</span>
      </button>

    </div>
  </div>
  <!-- <nz-card class="mg-t-16 flex-card p-lr16"> -->
  <nz-collapse nzAccordion>
    <div class="mt16 flex-card p-lr16">
      <div class="header header-green-background mg-t-16">
        <div class="header-text">
          <div class="title-chi-tieu">
            <span></span>
            <span>Thông tin chung</span>
          </div>
        </div>
      </div>
    </div>
    <form nz-form nzLayout="vertical" [formGroup]="formData">
      <nz-card class="mg-t-16 flex-card p-lr16">
        <div nz-row [nzGutter]="24">
          <div nz-col nzSpan="24">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Loại điều chuyển
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-radio-group formControlName="loaiDc" (ngModelChange)="onChangeLoaiDc($event)">
                  <label nz-radio *ngFor="let p of listLoaiDC" [nzValue]="p.value">{{p.text}}</label>
                  <!-- <label nz-radio nzValue="NOi_BO">Trong nội bộ Chi cục</label>
                  <label nz-radio nzValue="CHI_CUC">Giữa 2 chi cục trong cùng 1 cục</label>
                  <label nz-radio nzValue="CUC">Giữa 2 cục DTNN KV</label> -->
                </nz-radio-group>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </nz-card>
      <nz-card class="mg-t-16 flex-card p-lr16">

        <div *ngIf="formData.value.loaiDc === 'NOi_BO'" nz-row [nzGutter]="24">
          <div nz-col nzSpan="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Năm kế hoạch
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="nam" nzAllowClear>
                  <nz-option *ngFor="let p of listNam" [nzValue]="p.value" [nzLabel]="p.text"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-input-group nzAddOnAfter="/{{maQd}}">
                  <nz-input-number formControlName="soQdinh" [nzMin]="1" [nzMax]="999999999999" [nzStep]="1"
                    [nzSize]="'small'">
                  </nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày ký quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayKyQdinh" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày hiệu lực</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayPduyet" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="8">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Trích yếu
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="trichYeu" [readonly]="isDisabled()" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Tổng dự toán kinh phí(triệu đồng)
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="tongDuToanKp" [readonly]="true" />
              </nz-form-control>
            </nz-form-item>
          </div>





        </div>

        <div *ngIf="formData.value.loaiDc === 'CHI_CUC'" nz-row [nzGutter]="24">
          <div nz-col nzSpan="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Năm kế hoạch
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="nam" nzAllowClear>
                  <nz-option *ngFor="let p of listNam" [nzValue]="p.value" [nzLabel]="p.text"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-input-group nzAddOnAfter="/{{maQd}}">
                  <nz-input-number formControlName="soQdinh" [nzMin]="1" [nzMax]="999999999999" [nzStep]="1"
                    [nzSize]="'small'">
                  </nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày ký quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayKyQdinh" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày hiệu lực</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayPduyet" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="6">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Căn cứ vào quyết định điều chuyển của Tổng cục
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="canCuQdTc" nzAllowClear
                  (ngModelChange)="onChangeCanCuQdTc($event)">
                  <nz-option *ngFor="let p of listQuyetDinh" [nzValue]="p.id" [nzLabel]="p.soQdinh"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Số đề xuất/công văn
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="soCanCuQdTc" [readonly]="true" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Ngày trình duyệt Tổng cục</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="true" formControlName="ngayCanCuQdTc" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="18">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Trích yếu
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="trichYeu" [readonly]="isDisabled()" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Tổng dự toán kinh phí(triệu đồng)
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="tongDuToanKp" [readonly]="true" />
              </nz-form-control>
            </nz-form-item>
          </div>

        </div>

        <div *ngIf="formData.value.loaiDc === 'CUC'" nz-row [nzGutter]="24">
          <div nz-col nzSpan="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Năm kế hoạch
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="nam" nzAllowClear>
                  <nz-option *ngFor="let p of listNam" [nzValue]="p.value" [nzLabel]="p.text"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col nzSpan="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Loại quyết định
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="loaiQdinh" nzAllowClear
                  (ngModelChange)="onChangeLoaiQdinh($event)">
                  <nz-option *ngFor="let p of listLoaiQD" [nzValue]="p.value" [nzLabel]="p.text"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-input-group nzAddOnAfter="/{{maQd}}">
                  <nz-input-number formControlName="soQdinh" [nzMin]="1" [nzMax]="9" [nzStep]="1" [nzSize]="'small'">
                  </nz-input-number>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="2">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày ký quyết định</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayKyQdinh" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="2">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngày hiệu lực</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="isDisabled()" formControlName="ngayPduyet" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col nzSpan="5">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Căn cứ vào quyết định điều chuyển của Tổng cục
              </nz-form-label>
              <nz-form-control nz-col [nzErrorTip]="error">
                <nz-select [nzDisabled]="isDisabled()" formControlName="canCuQdTc" nzAllowClear
                  (ngModelChange)="onChangeCanCuQdTc($event)">
                  <nz-option *ngFor="let p of listQuyetDinh" [nzValue]="p.id" [nzLabel]="p.soQdinh"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Số QĐ Tổng cục
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="soCanCuQdTc" [readonly]="true" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="3">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Ngày trình duyệt Tổng cục</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-date-picker [nzDisabled]="true" formControlName="ngayCanCuQdTc" nzFormat="dd/MM/yyyy">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="18">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Trích yếu
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="trichYeu" [readonly]="isDisabled()" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Tổng dự toán kinh phí(triệu đồng)
              </nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="tongDuToanKp" [readonly]="true" />
              </nz-form-control>
            </nz-form-item>
          </div>

        </div>

        <div nz-row [nzGutter]="24">
          <div nz-col [nzSpan]="24">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                Căn cứ pháp lý
              </nz-form-label>
              <div class="list-file">
                <file-list [data]="canCu" [disabled]="isDisabled()" [isViewDetail]="isDisabled()"></file-list>
              </div>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="24">
            <nz-form-item>
              <nz-form-label [nzNoColon]="true">
                File đính kèm QĐ phê duyệt KH điều chuyển nội bộ của Tổng cục đã ban hành
              </nz-form-label>
              <div class="list-file">
                <file-list [data]="quyetDinh" [disabled]="isDisabled()" [isViewDetail]="isDisabled()"></file-list>
              </div>
            </nz-form-item>
          </div>
        </div>
      </nz-card>


      <!-- <div nz-col [nzSpan]="24">
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> File đính kèm QĐ đã ban hành</nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <div class="list-file">
                <nz-input-group [nzSuffix]="suffixTemplateInfo">
                  <input type="text" nz-input />
                </nz-input-group>
                <ng-template #suffixTemplateInfo>
                  <div class="icon-file-dinh-kem">
                    <i class="icon htvbdh_tcdt_tep"></i>
                    <input class="input-file" (change)="getNameFile($event)" type="file" />
                  </div>
                </ng-template>
              </div>
            </nz-form-control>
          </nz-form-item>
        </div> -->
    </form>

  </nz-collapse>
  <!-- </nz-card> -->
  <div class="mt16 flex-card p-lr16">

    <div nz-col [nzSpan]="24">
      <div class="header header-green-background mg-t-16">
        <div class="title-card">
          <div class="title-chi-tieu">
            <span></span>
            <span>QUYẾT ĐỊNH ĐIỀU CHUYỂN NỘI BỘ HÀNG DTQG TRONG CÙNG 1 CHI CỤC DTNN</span>
          </div>
        </div>
        <div class="btn-group">
          <button *ngIf="!isView && isCuc() && formData.value.loaiDc !== 'CUC'" type="button" class="btn btn-main ml-2"
            (click)="add()">
            <i class="icon htvbdh_dau-cong"></i>
            <span>Thêm</span>
          </button>
        </div>
      </div>



      <nz-table #expandTable [nzData]="listOfMapData" class="nowrap table-chi-tiet" nzBordered
        [nzFrontPagination]="false" [nzShowPagination]="false">
        <thead>
          <tr>
            <th [rowspan]="2">STT</th>
            <th [rowspan]="2"></th>
            <th [rowspan]="2"></th>
            <th [rowspan]="2" *ngIf="formData.value.loaiDc === 'NOi_BO'">Chi cục</th>
            <th [colspan]="9">Ngăn/lô/kho đang bảo quản hàng hoá</th>
            <th [rowspan]="2" *ngIf="formData.value.loaiDc !== 'NOi_BO'">Thời gian dự kiến điều chuyển</th>
            <th [colspan]="5" *ngIf="formData.value.loaiDc !== 'CUC'">Ngăn/lô/kho điều chuyển đến</th>
            <th [colspan]="7" *ngIf="formData.value.loaiDc === 'CUC'">Ngăn/lô/kho điều chuyển đến</th>
            <th [rowspan]="2" *ngIf="formData.value.loaiDc === 'NOi_BO'">Hành động</th>
          </tr>
          <tr>
            <th *ngIf="formData.value.loaiDc !== 'NOi_BO'">Chi cục</th>
            <th>Điểm kho</th>
            <th>Lô kho</th>
            <th>Loại HH</th>
            <th>Chủng loại hàng hóa</th>
            <th>ĐVT</th>
            <th>Tồn kho</th>
            <th>Số lượng điều chuyển</th>
            <th>Dự toán kinh phí(triệu đồng)</th>
            <th *ngIf="formData.value.loaiDc === 'NOi_BO'">Thời gian dự kiến điều chuyển</th>
            <th>Điểm kho</th>
            <th *ngIf="formData.value.loaiDc === 'CUC'">Nhà kho</th>
            <th *ngIf="formData.value.loaiDc === 'CUC'">Ngăn kho</th>
            <th>Lô kho</th>
            <th>Thay đổi thủ kho</th>
            <th>Tích lượng khả dụng</th>
            <th>SL phân bổ nhập ĐC</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let data of expandTable.data">
            <ng-container *ngFor="let item of mapOfExpandedData[data.key]">
              <tr *ngIf="(item.parent && item.parent.expand) || !item.parent">
                <td>1</td>
                <td [nzShowExpand]="item.isEx" [(nzExpand)]="item.expand"
                  (nzExpandChange)="collapse(mapOfExpandedData[data.key], item, $event)">
                </td>
                <td [nzShowExpand]="item.isCol" [(nzExpand)]="item.expand"
                  (nzExpandChange)="collapse(mapOfExpandedData[data.key], item, $event)">
                </td>
                <td *ngIf="formData.value.loaiDc === 'NOi_BO'">{{ item.chicuc }}</td>
                <td *ngIf="formData.value.loaiDc !== 'NOi_BO'">{{ item.chicuc }}</td>
                <td>{{ item.diemkho }}</td>
                <td>{{ item.lokho }}</td>
                <td>{{ item.loaihh }}</td>
                <td>{{ item.clhh }}</td>
                <td>{{ item.dvt }}</td>
                <td>{{ item.tonkho }}</td>
                <td>{{ item.sldc }}</td>
                <td>{{ item.dtkp }}</td>
                <td *ngIf="formData.value.loaiDc === 'NOi_BO'">{{ item.thoigian }}</td>
                <td *ngIf="formData.value.loaiDc !== 'NOi_BO'">{{ item.thoigian }}</td>
                <td>{{ item.diemkhoden }}</td>
                <td *ngIf="formData.value.loaiDc === 'CUC'">{{ item.ngankhoden }}</td>
                <td *ngIf="formData.value.loaiDc === 'CUC'">{{ item.nhakhoden }}</td>
                <td>{{ item.lokhoden }}</td>
                <td>{{ item.tdthukho }}</td>
                <td>{{ item.tlkd }}</td>
                <td>{{ item.slpb }}</td>
                <td class="text-center" *ngIf="formData.value.loaiDc === 'NOi_BO'">
                  <a *ngIf="data.trangThai !== STATUS.DU_THAO">
                    <i class="fa fa-eye"></i>
                  </a>
                  <a *ngIf="data.trangThai == STATUS.DU_THAO">
                    <i class="fa fa-pencil"></i>
                  </a>
                  <!-- <a *ngIf="data.trangThai == STATUS.DU_THAO" (click)="xoaItem(data)">
                    <i class="fa fa-trash-o do"></i>
                  </a> -->
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </tbody>
      </nz-table>






    </div>

  </div>

  <ng-template #error let-control>
    <app-template-error #error [control]="control"></app-template-error>
  </ng-template>

</div>
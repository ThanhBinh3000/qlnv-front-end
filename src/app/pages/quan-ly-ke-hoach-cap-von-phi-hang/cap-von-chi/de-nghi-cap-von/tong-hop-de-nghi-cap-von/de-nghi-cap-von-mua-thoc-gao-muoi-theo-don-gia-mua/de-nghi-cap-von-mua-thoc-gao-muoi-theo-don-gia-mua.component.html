<ng-container *ngIf="isDataAvailable">
	<nz-affix [nzOffsetTop]="globals.prop.MENU_LV1" class="btn-affix">
		<div class="btn-group">
			<button type="button" class="btn btn-sub" (click)="back()">
				<i class="fa fa-arrow-left"></i>
				<span>Quay lại</span>
			</button>
			<button *ngIf="saveStatus" type="button" class="btn btn-sub" (click)="action('save')">
				<i class="icon htvbdh_tcdt_save"></i>
				<span>Lưu</span>
			</button>
			<button *ngIf="submitStatus" type="button" class="btn btn-sub" (click)="action('submit')">
				<i class="icon htvbdh_tcdt_guiduyet"></i>
				<span>Trình duyệt</span>
			</button>
			<!-- <button *ngIf="passStatus" type="button" class="btn btn-sub" (click)="action('nonpass')">
					 <i class="icon htvbdh_tcdt_tuchoi"></i>
					 <span>Từ chối</span>
				</button>
				<button *ngIf="passStatus" type="button" class="btn btn-sub" (click)="action('pass')">
					 <i class="icon htvbdh_tcdt_pheduyet"></i>
					 <span>Duyệt</span>
				</button> -->
			<button *ngIf="approveStatus" type="button" class="btn btn-sub" (click)="action('nonapprove')">
				<i class="icon htvbdh_tcdt_tuchoi"></i>
				<span>Từ chối</span>
			</button>
			<button *ngIf="approveStatus" type="button" class="btn btn-sub" (click)="action('approve')">
				<i class="icon htvbdh_tcdt_pheduyet"></i>
				<span>Phê duyệt</span>
			</button>
			<button *ngIf="copyStatus" type="button" class="btn btn-sub" (click)="showDialogCopy()">
				<i nz-icon nzType="copy" nzTheme="outline"></i>
				<span>Copy</span>
			</button>
		</div>
	</nz-affix>

	<div class="bg-trang">
		<div class="mt16 flex-card p-lr16">
			<div class="header mg-t-16">
				<div class="header-text">
					<div class="title-chi-tieu">
						<span [ngClass]="statusClass()">{{getStatusName()}}</span>
						<span>Đề nghị cấp vốn chi dự trữ quốc gia</span>
					</div>
				</div>
			</div>
			<nz-card class="mt-2px flex-card data-table card-border-content table-card">
				<nz-table class="nowrap mt-16 table-chi-tiet">
					<thead>
						<tr>
							<th>Mã đề nghị</th>
							<th>Năm đề nghị</th>
							<th>Quyết định chỉ tiêu</th>
							<th>Loại đề nghị</th>
							<th>Căn cứ về giá</th>
							<th>Công văn</th>
							<th>Số lần</th>
							<th>Ngày lập</th>
							<th>Ngày trình duyệt</th>
							<th>Ngày duyệt</th>
							<th>Ngày phê duyệt</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>{{ baoCao.maDnghi }}</td>
							<td>{{ baoCao.namBcao }}</td>
							<td>{{ baoCao.soQdChiTieu }}</td>
							<td>
								<ng-container *ngFor="let item of loaiDns">
									<ng-container *ngIf="baoCao.loaiDnghi == item.id">
										{{ item.tenDm }}
									</ng-container>
								</ng-container>
							</td>
							<td>
								<ng-container *ngFor="let item of canCuGias">
									<ng-container *ngIf="baoCao.canCuVeGia == item.id">
										{{ item.tenDm }}
									</ng-container>
								</ng-container>
							</td>
							<td>
								<nz-upload [nzBeforeUpload]="beforeUploadCV" *ngIf="statusCv">
									<button nz-button>
										<i nz-icon nzType="upload"></i>
										Chọn tệp
									</button>
								</nz-upload>
								<div class="tep__sqd" (click)="downloadFileCv()">
									<!-- <i class="icon htvbdh_tcdt_tep"></i> -->
									<span>{{ baoCao.congVan?.fileName }}</span>
								</div>
							</td>
							<td>{{ baoCao.soLan }}</td>
							<td>{{ getDate(baoCao.ngayTao) }}</td>
							<td>{{ getDate(baoCao.ngayTrinh) }}</td>
							<td>{{ getDate(baoCao.ngayDuyet) }}</td>
							<td>{{ getDate(baoCao.ngayPheDuyet) }}</td>
						</tr>
					</tbody>
				</nz-table>
			</nz-card>
		</div>

		<div class="mt-16 flex-card p-lr16">
			<nz-card class="mt-2px flex-card data-table card-border-content table-card" nzTitle="Danh sách đơn vị">
				<div id="tablePrint">
					<nz-table class="table__body" nzBordered [nzScroll]="{x: scrollX}">
						<thead>
							<tr>
								<th rowspan="2" nzWidth="50px" nzLeft>STT</th>
								<th rowspan="2" nzWidth="250px" nzLeft>Đơn vị</th>
								<th rowspan="2">Số lượng (Kế hoạch)</th>
								<th rowspan="2">Đơn giá (theo quyết định)</th>
								<th rowspan="2">Giá trị theo kế hoạch</th>
								<th colspan="3">Lũy kế vốn cấp</th>
								<th rowspan="2">Vốn đề nghị cấp lần này
								</th>
								<th colspan="3">Vốn duyệt cấp lần này</th>
								<th rowspan="2">Số lũy kế sau khi cấp lần này</th>
								<th rowspan="2">Số còn được cấp</th>
								<th rowspan="2" style="width: 200px;">Ghi chú</th>
								<th rowspan="2" style="width: 50px;" *ngIf="status" nzRight></th>
							</tr>
							<tr>
								<th>Cấp vốn</th>
								<th>Ứng vốn</th>
								<th>Cộng</th>
								<th>Cấp vốn</th>
								<th>Ứng vốn</th>
								<th>Cộng</th>
							</tr>
							<tr>
								<th nzLeft>A</th>
								<th nzLeft>B</th>
								<th>1</th>
								<th>2</th>
								<th>3=1x2</th>
								<th>4</th>
								<th>5</th>
								<th>6=4+5</th>
								<th>7=3-6</th>
								<th>8</th>
								<th>9</th>
								<th>10=8+9</th>
								<th>11=6+10</th>
								<th>12=3-11</th>
								<th>D</th>
								<th *ngIf="status" nzRight></th>
							</tr>
							<tr>
								<th nzLeft></th>
								<th nzLeft>Tổng cộng</th>
								<th></th>
								<th></th>
								<th>{{displayValue(total.gtTheoKeHoach)}}</th>
								<th>{{displayValue(total.luyKeCapVon)}}</th>
								<th>{{displayValue(total.luyKeCapUng)}}</th>
								<th>{{displayValue(total.luyKeCong)}}</th>
								<th>{{displayValue(total.vonDnghiCapLanNay)}}</th>
								<th>{{displayValue(total.vonDuyetCapVon)}}</th>
								<th>{{displayValue(total.vonDuyetCapUng)}}</th>
								<th>{{displayValue(total.vonDuyetCong)}}</th>
								<th>{{displayValue(total.soLkeSauKhiCapLanNay)}}</th>
								<th>{{displayValue(total.soConDuocCap)}}</th>
								<th></th>
								<th *ngIf="status" nzRight></th>
							</tr>
						</thead>
						<tbody>
							<tr *ngFor="let data of baoCao.dnghiCapvonCtiets; let i = index">
								<ng-container *ngIf="!editCache[data.id].edit; else editTemplate">
									<td nzLeft>
										{{ i+1 }}
									</td>
									<td nzLeft>
										{{ data.tenDvi }}
									</td>
									<td>
										{{ displayValue(data.slKeHoach) }}
									</td>
									<ng-container *ngIf="userService.isTongCuc(); else showCucAndChiCuc">
										<td>
											{{displayValue(data.gtTheoKeHoach/data.slKeHoach)}}
										</td>
									</ng-container>
									<ng-template #showCucAndChiCuc>
										<td>
											{{ displayValue(data.donGia) }}
										</td>
									</ng-template>
									<td>
										{{ displayValue(data.gtTheoKeHoach) }}
									</td>
									<td>
										{{ displayValue(data.luyKeCapVon) }}
									</td>
									<td>
										{{ displayValue(data.luyKeCapUng) }}
									</td>
									<td>
										{{ displayValue(data.luyKeCong) }}
									</td>
									<td>
										{{ displayValue(data.vonDnghiCapLanNay)}}
									</td>
									<td>
										{{ displayValue(data.vonDuyetCapVon) }}
									</td>
									<td>
										{{ displayValue(data.vonDuyetCapUng) }}
									</td>
									<td>
										{{ displayValue(data.vonDuyetCong) }}
									</td>
									<td>
										{{ displayValue(data.soLkeSauKhiCapLanNay) }}
									</td>
									<td>
										{{ displayValue(data.soConDuocCap) }}
									</td>
									<td>
										{{ data.ghiChu }}
									</td>
									<td *ngIf="status" nzRight>
										<i *ngIf="data.maDvi == userInfo?.MA_DVI" class="fa fa-pencil"
											(click)="startEdit(data.id)"></i>
									</td>
								</ng-container>
								<ng-template #editTemplate>
									<td nzLeft>
										{{ i+1 }}
									</td>
									<td nzLeft>
										{{ editCache[data.id].data.tenDvi }}
									</td>
									<!-- <ng-container *ngIf="baoCao.soLan != 1; else moi"> -->
									<td>
										<input class="money-input" currencyMask [options]="amount"
											[(ngModel)]="editCache[data.id].data.slKeHoach"
											(ngModelChange)="changeModel(data.id)" />
									</td>
									<td>
										<input class="money-input" currencyMask [options]="amount"
											[(ngModel)]="editCache[data.id].data.donGia"
											(ngModelChange)="changeModel(data.id)" />
									</td>
									<!-- </ng-container> -->
									<!-- <ng-template #moi>
										<td>
											{{ displayValue(editCache[data.id].data.slKeHoach) }}
										</td>
										<td>
											{{ displayValue(editCache[data.id].data.donGia) }}
										</td>
									</ng-template> -->
									<td>
										{{ displayValue(editCache[data.id].data.gtTheoKeHoach) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.luyKeCapUng) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.luyKeCapVon) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.luyKeCong) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.vonDnghiCapLanNay) }}
									</td>
									<td>
										<input class="money-input" currencyMask [options]="amount"
											[(ngModel)]="editCache[data.id].data.vonDuyetCapVon"
											(ngModelChange)="changeModel(data.id)" />
									</td>
									<td>
										<input class="money-input" currencyMask [options]="amount"
											[(ngModel)]="editCache[data.id].data.vonDuyetCapUng"
											(ngModelChange)="changeModel(data.id)" />
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.vonDuyetCong) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.soLkeSauKhiCapLanNay) }}
									</td>
									<td>
										{{ displayValue(editCache[data.id].data.soConDuocCap) }}
									</td>
									<td>
										<input nz-input class="search__input"
											[(ngModel)]="editCache[data.id].data.ghiChu" />
									</td>
									<td *ngIf="status" nzRight>
										<a (click)="saveEdit(data.id)" class="save">Lưu</a>
										<a nz-popconfirm nzPopconfirmTitle="Bạn có chắc muốn hủy thao tác này?"
											(nzOnConfirm)="cancelEdit(data.id)" class="save">
											Hủy
										</a>
									</td>
								</ng-template>
							</tr>
						</tbody>
					</nz-table>
				</div>
				<div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 32 }" style="margin-top: 10px">
					<div nz-col nzSpan="24">
						<label class="search__label">Thuyết minh</label>
						<textarea rows="2" nz-input [(ngModel)]="baoCao.thuyetMinh" [disabled]="!status"></textarea>
					</div>
				</div>
				<div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 32 }" style="margin-top: 10px">
					<div nz-col class="gutter-row" [nzSpan]="3">
						Danh sách văn bản đính kèm
						<nz-upload [(nzFileList)]="fileList" [nzBeforeUpload]="beforeUpload" *ngIf="status">
							<button nz-button>
								<i nz-icon nzType="upload"></i>
								Chọn tệp
							</button>
						</nz-upload>
						<button nz-button [nzType]="'primary'" (click)="handleUpload()"
							[disabled]="fileList.length === 0" *ngIf="status" style="margin-top: 16px">
							Thêm vào danh sách
						</button>
					</div>
				</div>
				<div nz-row [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 32 }" style="margin-top: 10px">
					<div nz-col class="gutter-row" [nzSpan]="12">
						<nz-table nzBordered class="table__body">
							<thead>
								<tr>
									<th nzWidth="7%">STT</th>
									<th>Tên file</th>
									<th nzWidth="10%"></th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let data of baoCao.lstFiles; let i = index">
									<td>{{ i + 1 }} </td>
									<td>{{ data.fileName }}</td>
									<td>
										<a (click)="downloadFile(data.id)">
											<i class="fa fa-eye"></i>
										</a>
										<a *ngIf="status" (click)="deleteFile(data.id)">
											<i class="fa fa-trash-o do"></i>
										</a>
									</td>
								</tr>
							</tbody>
						</nz-table>
					</div>
				</div>
			</nz-card>
		</div>
	</div>
</ng-container>
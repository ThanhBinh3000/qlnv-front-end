<nz-affix [nzOffsetTop]="globals.prop.MENU_LV2" class="btn-affix">
  <div class="btn-group">
    <button type="button" class="btn btn-sub" (click)="quayLai()">
      <i class="fa fa-arrow-left"></i>
      <span>Quay lại</span>
    </button>
    <button *ngIf="formData.value.trangThai == '00' && !isView" type="button" class="btn btn-sub"
            (click)="banHanh()">
      <i class="icon htvbdh_tcdt_guiduyet"></i>
      <span>Lưu và gửi duyệt</span>
    </button>
    <button  type="button" class="btn btn-sub" *ngIf="formData.value.trangThai == '02'" >
      <i class="icon htvbdh_tcdt_tuchoi do"></i>
      <span>Từ chối</span>
    </button>
    <button *ngIf="formData.value.trangThai == '00' && !isView" type="button" class="btn btn-sub xanh" (click)="save()">
      <i class="icon htvbdh_luu"></i>
      <span>Lưu</span>
    </button>
  </div>
</nz-affix>
<div class="bg-trang">
  <nz-card class="mt16 flex-card p-lr16">
    <div class="header">
      <div class="header-text">
        <span
          [ngClass]="formData.value.trangThai == STATUS.DA_DUYET_LDC ? 'da-ban-hanh' : 'du-thao-va-lanh-dao-duyet'">
                        {{ formData.value.tenTrangThai }}
                    </span>
        <span>ĐỀ XUẤT PHƯƠNG ÁN GIÁ</span>
        </div>
      </div>
    <form nzLayout="vertical" nz-form [formGroup]="formData">
      <div nz-row [nzGutter]="20">
        <div nz-col [nzSpan]="2">
          <nz-form-item class="form-item">
            <nz-form-label nzRequired [nzNoColon]="true" [nzNoColon]="true" nzFor="nam-qd">Năm kế hoạch
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-select formControlName="namKeHoach"
                         [nzDisabled]="isView" nzAllowClear="true">
                <nz-option *ngFor="let p of dsNam" [nzValue]="p.value" [nzLabel]="p.text">
                </nz-option>
              </nz-select>
              <ng-template #error let-control>
                <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="3">
          <nz-form-item class="form-item">
            <nz-form-label  nzRequired [nzNoColon]="true" [nzNoColon]="true" nzFor="so-qd">Số công văn
            </nz-form-label>
            <nz-form-control  [nzErrorTip]="error">
              <nz-input-group nzAddOnAfter="{{maDx}}" id="so-qd">
                <nz-input-number type="text"  [nzDisabled]="isView" nz-input formControlName="soDeXuat" [nzMin]="1"
                                 [nzMax]="9999999" [nzStep]="1" [nzSize]="'small'">
                </nz-input-number>
              </nz-input-group>
              <ng-template #error let-control>
                <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="3">
          <nz-form-item class="form-item">
            <nz-form-label nzRequired  [nzNoColon]="true" [nzNoColon]="true" nzFor="ngay-qd">Ngày ký
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-date-picker [nzDisabled]="isView" formControlName="ngayKy" nzFormat="dd/MM/yyyy" id="ngay-qd"
                              class="search__input">
              </nz-date-picker>
              <ng-template #error let-control>
                <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="3">
          <nz-form-item class="form-item">
            <nz-form-label nzRequired [nzNoColon]="true" [nzNoColon]="true" >Người ký
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-input-group>
                <input type="text" [readOnly]="isView" nz-input formControlName="nguoiKy" />
              </nz-input-group>
              <ng-template #error let-control>
                <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="24">
          <nz-form-item class="form-item">
            <nz-form-label nzRequired [nzNoColon]="true" nzFor="ngay-qd">Trích yếu</nz-form-label>
            <nz-form-control>
              <textarea [readOnly]="isView" formControlName="trichYeu" rows="3" class="search__input" nz-input></textarea>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="4" >
          <nz-form-item class="form-item">
            <nz-form-label nzRequired [nzNoColon]="true" [nzNoColon]="true" >Loại hàng hóa
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-select formControlName="loaiVthh" [nzDisabled]="isView" nzAllowClear="true"
                         (ngModelChange)="onChangeLoaiVthh($event)">
                <nz-option *ngFor="let p of listVthh" [nzValue]="p.ma" [nzLabel]="p.ten">
                </nz-option>
                <ng-template #error let-control>
                  <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                  </ng-container>
                </ng-template>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="4">
          <nz-form-item class="form-item">
            <nz-form-label nzRequired [nzNoColon]="true" [nzNoColon]="true" nzFor="nam-qd">Loại giá
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-select formControlName="loaiGia" [nzDisabled]="isView" nzAllowClear="true">
                <nz-option *ngFor="let p of dsLoaiGia" [nzValue]="p.ma" [nzLabel]="p.giaTri">
                </nz-option>
                <ng-template #error let-control>
                  <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                  </ng-container>
                </ng-template>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="5" >
          <nz-form-item class="form-item">
            <nz-form-label [nzNoColon]="true"  nzRequired class="label-color-kh"> Quyết định giao chỉ tiêu kế hoạch năm
            </nz-form-label>
            <nz-form-control [nzErrorTip]="error">
              <nz-input-group >
                <nz-select  formControlName="qdCtKhNam" [nzDisabled]="isView" nzAllowClear="true">
                  <nz-option *ngFor="let p of dsQdPdKhlcnt" [nzValue]="p.soQd" [nzLabel]="p.soQd">
                  </nz-option>
                  <ng-template #error let-control>
                    <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                    </ng-container>
                  </ng-template>
                </nz-select>
              </nz-input-group>
              <ng-template #error let-control>
                <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                </ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </nz-card>
  <nz-tabset nzType="card">
    <nz-tab [nzTitle]="'Thông tin chung'" >
      <nz-card class="mt16 p-lr16 card-table pd-10">
            <nz-table #editRowTable [nzData]="pagTtChungs" [nzFrontPagination]="false" [nzShowPagination]="false">
              <thead>
              <tr>
                <th class="text-center" style="width: 4%;">STT</th>
                <th style="width: 12%;">Chủng loại hàng hóa</th>
                <th style="width: 10%;">Tiêu chuẩn chất lượng</th>
                <th style="width: 7%;">Số lượng</th>
                <th style="width: 7%;">Đơn vị tính</th>
                <th style="width: 25%;">Đơn giá đề nghị chưa VAT (đồng)</th>
                <th style="width: 25%;">Đơn giá đề nghị có VAT (đồng)</th>
                <th style="width: 4%;"></th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td></td>
                <td>
                  <nz-select (ngModelChange)="onChangecloaiVthh($event)" [(ngModel)]="rowItemTtc.cloaiVthh" name="cloaiVthh" [nzDisabled]="isView" nzAllowClear="true">
                    <nz-option  *ngFor="let p of listCloaiVthh" [nzValue]="p.ma" [nzLabel]="p.ten">
                    </nz-option>
                    <ng-template #error let-control>
                      <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                      </ng-container>
                    </ng-template>
                  </nz-select>
                </td>
                <td>
                  <nz-input-group>
                    <input type="text" name="tchuanCluong" [(ngModel)]="rowItemTtc.tchuanCluong" nz-input readonly />
                  </nz-input-group>
                </td>
                <td>
                  <nz-input-group>
                    <input type="text" name="soLuong" [(ngModel)]="rowItemTtc.soLuong"  nz-input  />
                  </nz-input-group>
                </td>
                <td>
                  <nz-input-group>
                    <input nz-input type="text" name="donViTinh"  [(ngModel)]="rowItemTtc.donViTinh" readonly>
                  </nz-input-group>
                </td>
                <td>
                  <nz-input-group>
                    <nz-input-number name="giaDn" [(ngModel)]="rowItemTtc.giaDn" [nzSize]="'small'" nz-input [nzMin]="0">
                    </nz-input-number>
                  </nz-input-group>
                </td>
                <td>
                  <nz-input-group>
                    <nz-input-number name="giaDnVat" [(ngModel)]="rowItemTtc.giaDnVat" [nzSize]="'small'" nz-input [nzMin]="0">
                    </nz-input-number>
                  </nz-input-group>
                </td>
                <td style="text-align: center;">
                  <a *ngIf="!isView">
                    <i class="fa fa-plus" (click)="themDataTableTtc()"></i>
                  </a>
                  <a *ngIf="(formData.value.trangThai == '00' || formData.value.trangThai == '03') && (!isView)">
                    <i class="icon  htvbdh_nhap-lai1 "></i>
                  </a>
                </td>
              </tr>
              <tr *ngFor="let data of pagTtChungs; let idx = index">
                <ng-container>
                  <td>{{ idx + 1 }}</td>
                  <td>{{ data.cloaiVthh }}</td>
                  <td>{{ data.tchuanCluong }}</td>
                  <td>{{ data.soLuong }}</td>
                  <td>{{ data.donViTinh }}</td>
                  <td>{{ data.giaDn }}</td>
                  <td>{{ data.giaDnVat }}</td>
                  <td style="text-align: center;">
                    <a *ngIf="!isView">
                      <i class=" fa fa-pencil"></i>
                    </a>
                    <a *ngIf="!isView" (click)="deleteItem(idx)">
                      <i class="fa fa-trash-o do"></i>
                    </a>
                  </td>
                </ng-container>
                <ng-template #editTemplate>
                  <td></td>
                  <td>
                  </td>
                  <td>
                  </td>

                  <td class="text-center">
                    <a  class="save">
                      <i class="fa fa-save"></i>
                    </a>
                    <a >
                      <i class="fa fa-ban do"></i> </a>
                  </td>
                </ng-template>
              </tr>
              </tbody>
            </nz-table>
      </nz-card>
    </nz-tab>
    <nz-tab [nzTitle]="'Căn cứ, phương pháp xác định giá'" >
      <nz-card class="mt16 p-lr16 card-table pd-10">
        <span class="sub-title">CĂN CỨ PHÁP LÝ</span>
        <br>
        <nz-table #editRowTable [nzData]="dataTable" [nzFrontPagination]="false" [nzShowPagination]="false">
          <thead>
          <tr>
            <th style="width: 2%;">STT</th>
            <th>Mô tả</th>
            <th>File đính kèm</th>
            <th style="width: 5%;">Hành động</th>
          </tr>
          <tr>
            <th class="text-center"> </th>
            <th>
              <input type="text" [(ngModel)]="rowItemCcXdg.moTa" nz-input name="moTa" />
            </th>
            <th>
              <nz-form-control>
                <nz-input-group nzSize="large" [nzAddOnAfter]="suffixIcon">
                  <input placeholder="Chọn file" [(ngModel)]="rowItemCcXdg.fileDinhKem.fileName" name="file"
                         nz-input disabled />
                </nz-input-group>
                <ng-template #suffixIcon>
                  <i class="icon htvbdh_tcdt_tep"></i>
                  <input class="input-file" (change)="getNameFile($event,'ccXdg')" type="file" />
                </ng-template>
              </nz-form-control>
            </th>
            <th class="text-left">
              <a *ngIf="!isView">
                <i class="icon htvbdh_dau-cong" (click)="themDataTable('ccXdg')"></i>
              </a>
              <a *ngIf="(formData.value.trangThai == '00' || formData.value.trangThai == '03') && (!isView)">
                <i class="icon  htvbdh_nhap-lai1 "></i>
              </a>
            </th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let data of dataTableCanCuXdg; let idx = index">
            <td class="text-center">{{ idx + 1 }}</td>
            <td>{{ data.moTa }}</td>
            <td>{{ data.fileDinhKem?.fileName }}</td>
            <td style="text-align: left; white-space: nowrap;">
              <a (click)="downloadFile(data.fileDinhKem)">
                <i class="icon htvbdh_tcdt_import "></i>
              </a>
              <a *ngIf="!isView">
                <i class="fa fa-pencil"></i>
              </a>
              <a *ngIf="!isView" >
                <i class="fa fa-trash-o do" ></i>
              </a>
            </td>
          </tr>
          </tbody>
        </nz-table>
        <span class="sub-title">PHƯƠNG PHÁP XÁC ĐỊNH GIÁ</span>
        <br>
        <form nzLayout="vertical" nz-form [formGroup]="formData" class="mb-10">
          <div nz-row [nzGutter]="16">
            <div nz-col [nzSpan]="4">
              <nz-form-item class="form-item">
                <nz-form-control [nzErrorTip]="error">
                  <nz-select formControlName="maPphapXdg" [nzDisabled]="isView" nzAllowClear="true">
                    <nz-option *ngFor="let p of dsPhuongAnGia, let i = index" [nzValue]="p.ma"
                               [nzLabel]="p.giaTri">
                    </nz-option>
                    <ng-template #error let-control>
                      <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                      </ng-container>
                    </ng-template>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col [nzSpan]="10" *ngIf="formData.value.maPphapXdg == 'XDG01'">
              <nz-form-item class="form-item">
                <nz-form-control [nzErrorTip]="error">
                  <nz-radio-group formControlName="loaiHangXdg">
                    <label nz-radio (select)="item[0]" *ngFor="let item of dsLoaiHangXdg, let idx = index"
                           [nzValue]="item.ma">{{item.giaTri}}</label>
                  </nz-radio-group>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>
        </form>
          <div nz-row [nzGutter]="20" *ngIf="formData.value.maPphapXdg == 'XDG01'">
            <nz-table #editRowTable [nzData]="pagPpXacDinhGias" [nzFrontPagination]="false" [nzShowPagination]="false">
              <thead>
              <tr>
                <th class="text-center" style="width: 4%;">STT</th>
                <th style="width: 35%;">Chủng loại hàng hóa</th>
                <th style="width: 15%;">Giá vốn nhập khẩu (đồng/đơn vị)</th>
                <th style="width: 15%;">Chi phí chung (đồng/đơn vị)</th>
                <th style="width: 15%;" *ngIf="formData.value.loaiHangXdg == 'XDG_LH02'">Chi phân bổ (đồng/đơn vị)</th>
                <th style="width: 15%;">Tổng chi phí (đồng/đơn vị)</th>
                <th style="width: 5%;">Hành động</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td></td>
                <td>
                  <nz-select [(ngModel)]="rowItemPpxdg.cloaiVthh" name="cloaiVthh" [nzDisabled]="isView" nzAllowClear="true">
                    <nz-option *ngFor="let p of listCloaiVthh" [nzValue]="p.ma" [nzLabel]="p.ten">
                    </nz-option>
                    <ng-template #error let-control>
                      <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
                      </ng-container>
                    </ng-template>
                  </nz-select>
                </td>
                <td>
                  <nz-input-group>
                    <nz-input-number  [(ngModel)]="rowItemPpxdg.giaVonNk" [nzSize]="'small'" nz-input [nzMin]="0">
                    </nz-input-number>
                  </nz-input-group>
                </td>
                <td>
                  <nz-input-group>
                    <nz-input-number  [(ngModel)]="rowItemPpxdg.chiPhiChung" [nzSize]="'small'" nz-input [nzMin]="0">
                    </nz-input-number>
                  </nz-input-group>
                </td>

                <td *ngIf="formData.value.loaiHangXdg == 'XDG_LH02'">
                  <nz-input-group >
                    <nz-input-number  name="giaDn" [(ngModel)]="rowItemPpxdg.chiPhiPhanBo" [nzSize]="'small'" nz-input [nzMin]="0">
                    </nz-input-number>
                  </nz-input-group>
                </td>
                <td>
                <nz-input-group>
                  <nz-input-number disabled name="giaDn" [(ngModel)]="rowItemPpxdg.giaVonNk + rowItemPpxdg.chiPhiChung + rowItemPpxdg.chiPhiPhanBo" [nzSize]="'small'" nz-input [nzMin]="0">
                  </nz-input-number>
                </nz-input-group>
              </td>
                <td style="text-align: center;">
                  <a >
                    <i *ngIf="!isView" class="fa fa-plus" (click)="themDataTable('ppxdg')"></i>
                  </a>
                  <a *ngIf="(formData.value.trangThai == '00' || formData.value.trangThai == '03') && (!isView)">
                    <i class="icon  htvbdh_nhap-lai1 "></i>
                  </a>
                </td>
              </tr>
              <tr *ngFor="let data of pagPpXacDinhGias; let idx = index">
                <ng-container>
                  <td>{{ idx + 1 }}</td>
                  <td>{{data.cloaiVthh}}</td>
                  <td>{{ data.giaVonNk }}</td>
                  <td>{{ data.chiPhiChung }}</td>
                  <td>{{ data.tongChiPhi }}</td>
                  <td style="text-align: center;">
                    <a *ngIf="!isView">
                      <i class=" fa fa-pencil"></i>
                    </a>
                    <a *ngIf="(formData.value.trangThai == '00' || formData.value.trangThai == '03') && (!isView)">
                      <i class="icon  htvbdh_nhap-lai1 "></i>
                    </a>
                  </td>
                </ng-container>
                <ng-template #editTemplate>
                  <td></td>
                  <td>
                  </td>
                  <td>
                  </td>

                  <td class="text-center">
                    <a *ngIf="!isView"  class="save">
                      <i class="fa fa-save"></i>
                    </a>
                    <a *ngIf="!isView" >
                      <i class="fa fa-ban do"></i> </a>
                  </td>
                </ng-template>
              </tr>
              </tbody>
            </nz-table>
          </div>
      </nz-card>
    </nz-tab>
    <nz-tab [nzTitle]="'Thông tin khảo sát giá'">
      <nz-card class="mt16 p-lr16 card-table pd-10">
        <span class="sub-title mb-10">KẾT QUẢ KHẢO SÁT GIÁ THỊ TRƯỜNG</span>
        <app-thong-tin-ksg [isTableKetQua]="true" [listCloaiVthh]="listCloaiVthh" [(dataTable)]="dataTableKsGia"
                           [isVat]="formData.value.loaiGia == 'LG01' || formData.value.loaiGia == 'LG03'">
        </app-thong-tin-ksg>
        <span class="sub-title mb-10">KẾT QUẢ THẨM ĐỊNH GIÁ</span>
        <app-thong-tin-ksg [isTableKetQua]="false" [(dataTable)]="dataTableKqGia"
                           [isVat]="formData.value.loaiGia == 'LG01' || formData.value.loaiGia == 'LG03'"></app-thong-tin-ksg>
      </nz-card>
    </nz-tab>

    <nz-tab [nzTitle]="'Phân tích, dự báo biến động giá'" >
      <form nzLayout="vertical" nz-form [formGroup]="formData" class="mb-10">
        <div nz-col [nzSpan]="24">
          <nz-form-item>
            <nz-form-label [nzNoColon]="true">Nội dung</nz-form-label>
            <textarea rows="3" class="search__input" nz-input placeholder="Nhập text" formControlName="noiDung" [readOnly]="isView"></textarea>
          </nz-form-item>
        </div>
      </form>
    </nz-tab>
  </nz-tabset>
  <div nz-col [nzSpan]="24">
    <form nzLayout="vertical" nz-form [formGroup]="formData" class="mb-10">
      <nz-form-item>
        <nz-form-label [nzNoColon]="true"> Ghi chú </nz-form-label>
        <textarea rows="3" class="search__input" nz-input formControlName="ghiChu" [readOnly]="isView"></textarea>
      </nz-form-item>
    </form>
  </div>
  <nz-card class="mt16 flex-card p-lr16">
  </nz-card>
</div>

<ng-container *ngIf="!isBienBan">
  <nz-affix [nzOffsetTop]="globals.prop.MENU_LV2" class="btn-affix">
    <div class="btn-group">
      <button type="button" class="btn btn-sub" (click)="quayLai()">
        <i class="fa fa-arrow-left"></i>
        <span>Quay lại</span>
      </button>
      <button type="button" class="btn btn-sub" (click)="inBienBan(id,'BTT','HS')">
        <i class="icon htvbdh_totrinh"></i>
        <span> In/Xem trước </span>
      </button>
      <!--      <button (click)="approve(id,STATUS.DA_KY,'Bạn có muốn xác nhận ?')"-->
      <!--              [disabled]="formData.value.kqKiemTra != 1"-->
      <!--              class="btn btn-sub" type="button">-->
      <!--        <i class="icon htvbdh_tcdt_pheduyet"></i>-->
      <!--        <span>Xác nhận</span>-->
      <!--      </button>-->
      <button type="button" class="btn btn-sub xanh"
              [disabled]="formData.value.kqKiemTra != 1"
              (click)="save()">
        <i class="icon htvbdh_tcdt_pheduyet"></i>
        <span>Xác nhận</span>
      </button>
    </div>
  </nz-affix>
  <div class="bg-trang">
    <div class="header header-green-background">
      <div class="header-text">
        <div class="title-chi-tieu">
                    <span [ngClass]="formData.value.trangThai == STATUS.DA_DUYET_LDC ? 'status-xanh' : 'status-do'">
                        {{ formData.value.tenTrangThai }}
                    </span>
          <span>Hồ sơ kỹ thuật nhập vật tư</span>
        </div>
      </div>
    </div>
    <nz-alert class="mg-t-10"
              *ngIf="formData.value.trangThai == STATUS.TU_CHOI_LDC || formData.value.trangThai == STATUS.TU_CHOI_TP "
              nzShowIcon nzType="error" nzMessage="Lý do từ chối" nzDescription="{{formData.value.ldoTuchoi}}">
    </nz-alert>

    <!--Thông tin chung-->
    <nz-card class="mg-t-16 flex-card p-lr16">
      <div class="header header-green-background mg-t-16">
        <div class="header-text">
          <div class="title-chi-tieu">
            <span></span>
            <span>Thông tin chung</span>
          </div>
        </div>
      </div>
      <form nzLayout="vertical" nz-form [formGroup]="formData">
        <div nz-row [nzGutter]="24">
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Số hồ sơ kỹ thuật</nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <input nz-input readonly formControlName="soHsktNh"/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số biên bàn lấy mẫu/Bàn giao mẫu (Khi nhập)
              </nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <input nz-input readonly formControlName="soBbLayMauNh"/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số QĐ giao nhiệm vụ nhập hàng
              </nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <input nz-input readonly formControlName="soQdGiaoNvNh"/>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Cán bộ tạo HSKT</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <input nz-input readonly formControlName="canBoTaoHoSoNh"/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Đơn vị nhập hồ sơ kỹ thuật</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24">
                <input readonly placeholder="" nz-input formControlName="tenDvi"/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Ngày tạo HSKT</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <nz-date-picker nzDisabled formControlName="ngayTaoNh" [nzFormat]="globals.dateFormat">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Ngày duyệt HSKT</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <nz-date-picker nzDisabled formControlName="ngayDuyetNh" [nzFormat]="globals.dateFormat">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Điểm kho</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <input [readonly]="true" nz-input formControlName="tenDiemKho" readonly/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Ngăn/Lô kho</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <input *ngIf="!this.formData.value.tenLoKho" [readonly]="true" nz-input
                       formControlName="tenNganKho" readonly/>
                <input *ngIf="this.formData.value.tenLoKho" [readonly]="true" nz-input
                       formControlName="tenLoKho" readonly/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Cán bộ kiểm tra HSKT trước khi xuất</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <input nz-input formControlName="canBoTaoHoSo"/>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true">Ngày kiểm tra HSKT trước khi xuất</nz-form-label>
              <nz-form-control nz-col [nzSpan]="24" [nzErrorTip]="error">
                <nz-date-picker nzDisabled formControlName="ngayTao" [nzFormat]="globals.dateFormat">
                </nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
          <div nz-col [nzSpan]="4">
            <nz-form-item>
              <nz-form-label nzRequired [nzNoColon]="true"> Số biên bàn lấy mẫu/Bàn giao mẫu (Khi xuất)
              </nz-form-label>
              <nz-form-control [nzErrorTip]="error">
                <nz-input-group nzAddOnAfterIcon="folder-open" (click)="openDialogBbLayMauXuat()">
                  <input [readonly]="true" nz-input formControlName="soBbLayMau" readonly/>
                </nz-input-group>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </form>
    </nz-card>
    <!--End thông tin chung-->

    <div class="header header-green-background mg-t-16">
      <div class="header-text">
        <div class="title-chi-tieu">
          <span></span>
          <span>Danh sách hồ sơ tài liệu</span>
        </div>
      </div>
    </div>
    <nz-table [nzData]="dataTable" class="nowrap pd-10" nzBordered>
      <thead>
      <tr>
        <th width="50px" class="text-center">STT</th>
        <th>Tên hồ sơ tài liệu</th>
        <th width="150px">Loại tài liệu</th>
        <th width="100px">Số lượng</th>
        <th>Ghi chú</th>
        <th>File đính kèm</th>
        <th width="100px" class="text-center">Trạng thái kiểm tra</th>
        <th width="100px"></th>
      </tr>
      <tr>
        <th></th>
        <th><input nz-input [(ngModel)]="hoSoRow.ten"/></th>
        <th>
          <nz-select [(ngModel)]="hoSoRow.loai">
            <nz-option nzValue="Bản gốc" nzLabel="Bản gốc"></nz-option>
            <nz-option nzValue="Bản chụp" nzLabel="Bản chụp"></nz-option>
          </nz-select>
        </th>
        <th><input nz-input [(ngModel)]="hoSoRow.soLuong"/></th>
        <th><input nz-input [(ngModel)]="hoSoRow.ghiChu"/></th>
        <th>
          <nz-form-control>
            <nz-input-group nzSize="small" [nzAddOnAfter]="suffixIcon">
              <input placeholder="Chọn file" [(ngModel)]="hoSoRow.fileName" nz-input disabled/>
            </nz-input-group>
            <ng-template #suffixIcon>
              <i class="icon htvbdh_tcdt_tep"></i>
              <input class="input-file" (change)="getNameFile($event)" type="file"/>
            </ng-template>
          </nz-form-control>
        </th>
        <th width="100px" class="text-center"><label style="margin-right: 0px;" nz-checkbox
                                                     [(ngModel)]="hoSoRow.trangThai"></label></th>
        <th>
          <a (click)="themHoSo()">
            <i class="fa fa-plus" title="Thêm mới"></i>
          </a>
          <a (click)="nhapLaiHoSo()">
            <i class="fa fa-refresh" title="Nhập lại"></i>
          </a>
        </th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let item of viewTableHoSo;let i = index">
        <ng-container *ngIf="!item.edit">
          <td class="text-center">{{i + 1}}</td>
          <td>{{item.ten}}</td>
          <td>{{item.loai}}</td>
          <td>{{item.soLuong|number:globals.numberFormat}}</td>
          <td>{{item.ghiChu}}</td>
          <td>
            <a nz-button nzType="link"
               (click)="downloadFile(item.fileDinhKem[0])">
              {{(item.fileDinhKem && item.fileDinhKem.length > 0) ? item.fileDinhKem[0].fileName : null}}
            </a>
          </td>
          <td class="text-center"><label nz-checkbox [(ngModel)]="item.trangThai" disabled="true"></label></td>
          <td>
            <a (click)="downloadFile(item.fileDinhKem[0])">
              <i class="fa fa-download" title="Tải tài liệu"></i>
            </a>
            <a (click)="suaHoSo(item)">
              <i class="fa fa-edit" title="Chỉnh sửa"></i>
            </a>
            <a>
              <i class="fa fa-trash-o do" nz-popconfirm nz-button
                 nzPopconfirmTitle="Bạn có chắc muốn xóa ?"
                 (nzOnConfirm)="xoaHoSo(item)" title="Xóa"></i>
            </a>
          </td>
        </ng-container>
        <ng-container *ngIf="item.edit">
          <td class="text-center">{{i + 1}}</td>
          <td><input nz-input [(ngModel)]="item.ten"/></td>
          <td>
            <nz-select [(ngModel)]="item.loai">
              <nz-option nzValue="Bản gốc" nzLabel="Bản gốc"></nz-option>
              <nz-option nzValue="Bản chụp" nzLabel="Bản chụp"></nz-option>
            </nz-select>
          </td>
          <td><input nz-input [(ngModel)]="item.soLuong"/></td>
          <td><input nz-input [(ngModel)]="item.ghiChu"/></td>
          <td>
            <input nz-input [(ngModel)]="item.fileName"/>
            <!--<nz-form-control>
              <nz-input-group nzSize="large" [nzAddOnAfter]="suffixIcon">
                <input placeholder="Chọn file" [(ngModel)]="item.fileName" nz-input disabled/>
              </nz-input-group>
              <ng-template #suffixIcon>
                <i class="icon htvbdh_tcdt_tep"></i>
                <input class="input-file" (change)="getNameFile($event)" type="file"/>
              </ng-template>
            </nz-form-control>-->
          </td>
          <td class="text-center"><label nz-checkbox [(ngModel)]="item.trangThai"></label></td>
          <td>
            <a>
              <i class="fa fa-save" nz-popconfirm nz-button
                 nzPopconfirmTitle="Bạn có chắc muốn lưu thay đổi ?"
                 (nzOnConfirm)="luuHoSo(item)" title="Lưu"></i>
            </a>
            <a (click)="huySuaHoSo()">
              <i class="fa fa-ban do" title="Xóa"></i>
            </a>
          </td>
        </ng-container>
      </tr>
      </tbody>
    </nz-table>

    <div class="header header-green-background mg-t-16">
      <div class="header-text">
        <div class="title-chi-tieu">
          <span></span>
          <span>Danh sách biên bản</span>
        </div>
      </div>
    </div>
    <nz-table [nzData]="dataTableBienBan" class="nowrap pd-10" nzBordered>
      <thead>
      <tr>
        <th class="text-center" nzWidth="50px">STT</th>
        <th>Tên biên bản</th>
        <th>Ngày lập biên bản</th>
        <th>Thời điểm lập</th>
        <th>File đính kèm</th>
        <th nzWidth="100px" class="text-center">Trạng thái</th>
        <th nzWidth="100px"></th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let item of this.formData.value.xhHoSoKyThuatDtl, let i = index ">
        <td class="text-center">{{ i + 1 }}</td>
        <td>{{ getTenLoaiBb(item.loaiBb)}}</td>
        <td>{{ item.ngayLapBb|date:globals.dateFormat }}</td>
        <td>{{ item.noiDung }}</td>
        <td>
          <a nz-button nzType="link"
             (click)="downloadFile(item.fileDinhKem[0])">
            {{(item.fileDinhKem && item.fileDinhKem.length > 0) ? item.fileDinhKem[0].fileName : null}}
          </a>
        </td>
        <td>{{ item.trangThai == STATUS.DA_KY ? 'Đã ký' : 'Dự thảo' }}</td>
        <!--        <td class="text-center"><label nz-checkbox [nzChecked]="item.trangThai==STATUS.DA_KY" nzDisabled="true"></label></td>-->
        <td class="text-left">
          <!--<a *ngIf="formData.value.id > 0 && item.id && item.trangThai == STATUS.DA_KY "
             (click)="redirectToBienBan(false,item)">
            <i class="fa fa-eye" title="Xem chi tiết"></i>
          </a>
          <a *ngIf="formData.value.id > 0 && item.trangThai != STATUS.DA_KY"
             (click)="redirectToBienBan(false,item)">
            <i class="fa fa-pencil" title="Sửa"></i>
          </a>
          <a *ngIf="formData.value.id > 0 && item.id && item.trangThai == STATUS.DU_THAO "
             (click)="redirectToBienBan(false,item)">
            <i class="fa fa-trash do"></i>
          </a>-->
          <a (click)="downloadFile(item.fileDinhKem[0])">
            <i class="fa fa-download" title="Tải tài liệu"></i>
          </a>
          <a *ngIf="item.trangThai == STATUS.DA_KY" (click)="redirectToBienBan(true,item)">
            <i class="fa fa-eye" title="Xem chi tiết"></i>
          </a>
          <a *ngIf="item.trangThai != STATUS.DA_KY" (click)="redirectToBienBan(false,item)">
            <i class="fa fa-edit" title="Chỉnh sửa"></i>
          </a>
          <a (click)="inBienBan(id,'BDG',item.loaiBb)">
            <i class="fa fa-print" title="Xem biên bản"></i>
          </a>
        </td>
      </tr>
      </tbody>
    </nz-table>
    <div class="header header-green-background mg-t-16">
      <div class="header-text">
        <div class="title-chi-tieu">
          <span></span>
          <span>Kết quả kiểm tra hồ sơ kỹ thuật trước khi xuất kho</span>
        </div>
      </div>
    </div>

    <div class="mg-t-10" nz-col nzSpan="24">
      <nz-form-item>
        <nz-form-control [nzErrorTip]="error">
          <nz-radio-group [(ngModel)]="formData.value.kqKiemTra" nzSpan="8" (ngModelChange)="changeKqKiemtra($event)">
            <label nz-radio [nzValue]="o.value" *ngFor="let o of radioData"
                   [nzDisabled]="o.disable">{{ o.label }}</label>
          </nz-radio-group>
        </nz-form-control>
      </nz-form-item>
    </div>

    <ng-template #error let-control>
      <app-template-error #error [control]="control"></app-template-error>
    </ng-template>
  </div>
</ng-container>
<ng-container *ngIf="isBienBan">
  <app-chi-tiet-bien-ban-kiem-tra-dau-gia (showListEvent)="backMain($event)" [isView]="isViewBb" [data]="dataBb"
                                          [dataHdr]="this.formData.value"
                                          (saveDtl)="saveDtl($event)">
  </app-chi-tiet-bien-ban-kiem-tra-dau-gia>
</ng-container>
<nz-modal [(nzVisible)]="showDlgPreview" nzWidth="70%"
          (nzOnCancel)="closeDlg()">
  <div *nzModalContent class="modal__content">
    <pdf-viewer [src]="pdfSrc" [render-text]="true" style="width: 100%; height: 600px;"></pdf-viewer>
  </div>
  <div *nzModalFooter>
    <button nz-button (click)="printPreview()"
            class="modal__button--save">
      <i class="icon htvbdh_printer"></i>
      In
    </button>
    <button nz-button (click)="downloadPdf(templateName)"
            class="modal__button--save">
      <i class="icon htvbdh_file-pdf"></i>
      Xuất .pdf
    </button>
    <button nz-button (click)="downloadWord(templateName)"
            class="modal__button--save">
      <i class="icon htvbdh_file-word"></i>
      Xuất .docx
    </button>
    <button nz-button (click)="closeDlg()" class="modal__button--cancel">
      <i nz-icon nzType="close-circle" nzTheme="fill" class="icon-cancel"></i>
      Đóng
    </button>
  </div>
</nz-modal>

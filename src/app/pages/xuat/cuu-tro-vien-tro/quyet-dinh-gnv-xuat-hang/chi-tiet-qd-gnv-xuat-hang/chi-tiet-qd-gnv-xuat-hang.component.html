<nz-affix [nzOffsetTop]="globals.prop.MENU_LV1" class="btn-affix">
  <div class="btn-group">
    <button (click)="quayLai()" class="btn btn-sub" type="button">
      <i class="fa fa-arrow-left"></i>
      <span>Quay lại</span>
    </button>
    <button
      (click)="reject(id,STATUS.TU_CHOI_LDC)"
      *ngIf="userService.isAccessPermisson('XHDTQG_XCTVT_QDGNVXH_DUYET_LDCUC') && (formData.value.trangThai===STATUS.CHO_DUYET_LDC && userService.isCuc())"
      class="btn btn-sub"
      type="button">
      <i class="icon htvbdh_tcdt_tuchoi do"></i>
      <span>Từ chối</span>
    </button>
    <button
      (click)="approve(id,STATUS.DA_DUYET_LDC,'Bạn có muốn duyệt quyết định này')"
      *ngIf="userService.isAccessPermisson('XHDTQG_XCTVT_QDGNVXH_DUYET_LDCUC') && (formData.value.trangThai===STATUS.CHO_DUYET_LDC && userService.isCuc())"
      class="btn btn-sub"
      type="button">
      <i class="icon htvbdh_tcdt_pheduyet"></i>
      <span>Duyệt</span>
    </button>
    <button
      (click)="saveAndSend()"
      *ngIf="userService.isAccessPermisson('XHDTQG_XCTVT_QDGNVXH_THEM') && (formData.value.trangThai===STATUS.DU_THAO && userService.isCuc())"
      class="btn btn-sub"
      type="button">
      <i class="icon htvbdh_tcdt_guiduyet"></i>
      <span>Lưu và gửi duyệt</span>
    </button>
    <button
      (click)="save()"
      *ngIf="userService.isAccessPermisson('XHDTQG_XCTVT_QDGNVXH_THEM') &&
       ((formData.value.trangThai===STATUS.DA_DUYET_LDC && userService.isChiCuc())||(formData.value.trangThai===STATUS.DU_THAO && userService.isCuc()))"
      class="btn btn-main" type="
        button">
      <i class="icon htvbdh_tcdt_save"></i>
      <span>Lưu</span>
    </button>
  </div>
</nz-affix>
<div class="bg-trang">
  <div class="mt16 flex-card p-lr16">
    <div class="header header-green-background mg-t-16">
      <div class="header-text">
        <div class="title-chi-tieu">
          <span
            [ngClass]="formData.value.trangThai == STATUS.DA_DUYET_LDC ? 'status-xanh' : 'status-do'">
            {{ formData.value.tenTrangThai }}
          </span>
          <span>Quyết định giao nhiệm vụ xuất hàng cứu trợ, viện trợ</span>
        </div>
      </div>
    </div>
  </div>
  <nz-card class="mt16 flex-card p-lr16">
    <form [formGroup]="formData" nz-form nzLayout="vertical">
      <ng-template #error let-control>
        <ng-container *ngIf="control.hasError('required')">{{globals.prop.REQUIRED}}
        </ng-container>
      </ng-template>
      <div [nzGutter]="24" nz-row>
        <div nz-col nzSpan="3">
          <nz-form-item>
            <nz-form-label [nzNoColon]="true" class="label-color-kh"> Năm xuất
            </nz-form-label>
            <nz-select formControlName="nam" [nzDisabled]="formData.value.trangThai!==STATUS.DU_THAO">
              <nz-option *ngFor="let p of listNam" [nzLabel]="p.text" [nzValue]="p.value"></nz-option>
            </nz-select>
          </nz-form-item>
        </div>
        <div [nzSpan]="5" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Số QĐ xuất hàng</nz-form-label>
            <nz-form-control>
              <nz-input-group nzAddOnAfter="{{userInfo.MA_QD}}">
                <nz-input-number [nzDisabled]="formData.value.trangThai!==STATUS.DU_THAO" [nzMax]="9999999" [nzMin]="1"
                                 [nzSize]="'small'" [nzStep]="1"
                                 formControlName="soQd">
                </nz-input-number>
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="5" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Ngày ký QĐ xuất hàng</nz-form-label>
            <nz-form-control [nzSpan]="24" nz-col>
              <nz-date-picker [nzDisabled]="formData.value.trangThai!==STATUS.DU_THAO" class="search__input"
                              formControlName="ngayKy"
                              nzFormat="dd/MM/yyyy">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="5" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Căn cứ trên QĐ PD phương án</nz-form-label>
            <nz-form-control [nzErrorTip]="error" nz-col nzSpan="24">
              <nz-select (ngModelChange)="changeQdPd($event)" [nzDisabled]="formData.value.trangThai !== STATUS.DU_THAO"
                         formControlName="idQdPd" nzAllowClear
                         nzShowSearch>
                <nz-option *ngFor="let p of dsQdPd" [nzLabel]="p.soQd" [nzValue]="p.id"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="6" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Đơn vị ra QĐ giao nv xuất hàng</nz-form-label>
            <nz-form-control [nzSpan]="24" nz-col>
              <input [readonly]="true" formControlName="tenDvi" nz-input/>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="4" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Loại hàng hóa</nz-form-label>
            <nz-form-control [nzSpan]="24" nz-col>
              <input [readonly]="true" formControlName="tenLoaiVthh" nz-input/>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="4" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Tên hàng hóa</nz-form-label>
            <nz-form-control>
              <input [readonly]="true" formControlName="tenVthh" nz-input/>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="3" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Số lượng</nz-form-label>
            <nz-form-control>
              <nz-input-number [nzFormatter]="globals.formatter" [nzMin]="1" [nzParser]="globals.parser"
                               [nzSize]="'small'" [nzStep]="1"
                               class="text-right" formControlName="tongSoLuong" nz-input
                               nzDisabled>
              </nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="2" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Đơn vị tính</nz-form-label>
            <nz-form-control>
              <input [readonly]="true" formControlName="donViTinh" nz-input/>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="5" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true"> Thời gian giao nhận hàng</nz-form-label>
            <nz-form-control [nzSpan]="24" nz-col>
              <nz-date-picker [nzDisabled]="formData.value.trangThai!==STATUS.DU_THAO" class="search__input"
                              formControlName="thoiGianGiaoNhan"
                              nzFormat="dd/MM/yyyy">
              </nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div [nzSpan]="6" nz-col>
          <nz-form-item>
            <nz-form-label [nzNoColon]="true" nzRequired> Trích yếu</nz-form-label>
            <nz-form-control [nzSpan]="24" nz-col>
              <input [readOnly]="formData.value.trangThai!==STATUS.DU_THAO" formControlName="trichYeu" nz-input/>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label [nzNoColon]="true" nzSpan="24">
            Căn cứ pháp lý
          </nz-form-label>
        </nz-form-item>
        <nz-form-item>
          <div class="list-file" nz-col nzSpan="24">
            <file-list [data]="formData.value.canCu" [isViewDetail]="formData.value.trangThai!==STATUS.DU_THAO">
            </file-list>
          </div>
        </nz-form-item>
      </div>
      <div nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label [nzNoColon]="true" nzSpan="24">
            File đính kèm QĐ giao nhiệm vụ xuất hàng đã ký
          </nz-form-label>
        </nz-form-item>
        <nz-form-item>
          <div class="list-file" nz-col nzSpan="24">
            <file-list [data]="formData.value.fileDinhKem" [isViewDetail]="formData.value.trangThai!==STATUS.DU_THAO">
            </file-list>
          </div>
        </nz-form-item>
      </div>
      <div class="mt-16">
        <nz-table #tblData [nzData]="noiDungCuuTroView" class="nowrap table-chi-tiet" nzBordered>
          <thead>
          <tr>
            <th [rowspan]="2"></th>
            <th [rowspan]="2" style="width: 35px">STT</th>
            <th [rowspan]="2">Nội dung xuất cứu trợ, viện trợ</th>
            <th [rowspan]="2">Tên chi cục</th>
            <th [colspan]="2">Chủng loại hàng hóa</th>
            <th [rowspan]="2">Điểm kho</th>
            <th [colspan]="3">Thông tin lô kho</th>
            <th [colspan]="2">SL xuất CT, VT</th>
            <th [rowspan]="2">Trạng thái</th>
            <th [rowspan]="2" style="width: 10%">Hành động</th>
          </tr>
          <tr>
            <th>Tên chủng loại hàng hóa</th>
            <th>Tồn kho</th>
            <th>Lô kho</th>
            <th>Tổng tích lượng</th>
            <th>Tồn kho</th>
            <th>Số lượng</th>
            <th>Đơn vị tính</th>
          </tr>
          <tr>
            <th></th>
            <th></th>
            <th>
              <nz-select nzAllowClear [(ngModel)]="noiDungRow.noiDung" [ngModelOptions]="{standalone: true}"
                         nzPlaceHolder="Chọn nội dung" nzShowSearch>
                <nz-option *ngFor="let p of dsNoiDung" [nzLabel]="p.noiDung" [nzValue]="p.noiDung"></nz-option>
              </nz-select>
            </th>
            <th>
              <nz-select [nzDisabled]="userService.isChiCuc()" nzAllowClear [(ngModel)]="noiDungRow.maDvi"
                         [ngModelOptions]="{standalone: true}"
                         nzPlaceHolder="Chọn đơn vị" nzShowSearch>
                <nz-option *ngFor="let p of dsDonVi" [nzLabel]="p.tenDvi" [nzValue]="p.maDvi"></nz-option>
              </nz-select>
            </th>
            <th></th>
            <th></th>
            <th>
              <nz-select *ngIf="userService.isChiCuc()" nzAllowClear [(ngModel)]="noiDungRow.maDiemKho"
                         [ngModelOptions]="{standalone: true}"
                         (ngModelChange)="changeDiemKho()"
                         nzPlaceHolder="Chọn điểm kho" nzShowSearch>
                <nz-option *ngFor="let p of dsDiemKho" [nzLabel]="p.tenDvi" [nzValue]="p.maDvi"></nz-option>
              </nz-select>
            </th>
            <th>
              <nz-select *ngIf="userService.isChiCuc()" nzAllowClear [(ngModel)]="noiDungRow.maDiaDiem"
                         [ngModelOptions]="{standalone: true}"
                         nzPlaceHolder="Chọn lô kho" nzShowSearch>
                <nz-option *ngFor="let p of dsLoKhoFilter" [nzLabel]="p.tenDvi" [nzValue]="p.maDvi"></nz-option>
              </nz-select>
            </th>
            <th></th>
            <th></th>
            <th>
              <!--    <nz-input-number [nzMax]="9999999" [nzMin]="1" [nzSize]="'small'" [nzStep]="1"
                                   nzPlaceHolder="Số lượng 1"
                                   [ngModelOptions]="{standalone: true}" [(ngModel)]="noiDungRow.soLuongNoiDung">
                  </nz-input-number>-->

              <p>
                <nz-input-number *ngIf="!userService.isChiCuc()" [nzMax]="9999999" [nzMin]="1" [nzSize]="'small'"
                                 [nzStep]="1"
                                 nzPlaceHolder="Số lượng giao"
                                 [ngModelOptions]="{standalone: true}" [(ngModel)]="noiDungRow.soLuongGiao">
                </nz-input-number>
              </p>
              <p>
                <nz-input-number *ngIf="userService.isChiCuc()" [nzMax]="9999999" [nzMin]="1" [nzSize]="'small'"
                                 [nzStep]="1"
                                 nzPlaceHolder="Số lượng xuất"
                                 [ngModelOptions]="{standalone: true}" [(ngModel)]="noiDungRow.soLuongXuat">
                </nz-input-number>
              </p>
            </th>
            <th></th>
            <th></th>
            <th style="text-align: left"><a>
              <i class="fa fa-plus"
                 *ngIf="(userService.isCuc() && (formData.value.trangThai===STATUS.DU_THAO||formData.value.trangThai===STATUS.TU_CHOI_LDC))||(userService.isChiCuc() && formData.value.trangThai===STATUS.DA_DUYET_LDC)"
                 (click)="addRow()"></i>
            </a></th>
          </tr>
          </thead>
          <tbody>

          <ng-container *ngFor="let item of tblData.data, let i = index;">
            <tr>
              <td (nzExpandChange)="onExpandStringChange(item.idVirtual, $event)"
                  [nzExpand]="expandSetString.has(item.idVirtual)"
                  nzShowExpand="true"
                  style="width: 35px"></td>
              <td>{{i + 1}}</td>
              <td>{{ item.noiDung }}</td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td>{{item.soLuong}}</td>
              <td></td>
              <td></td>
              <td>
                <!--<a (click)="addChiCuc(i,item.label)">
                  <i class="fa fa-plus"></i>
                </a>-->
                <!--              <a (click)="deletePhanLo(item.idVirtual)">-->
                <a>
                  <i class="fa fa-trash-o do"></i>
                </a>
              </td>
            </tr>
            <ng-container *ngIf="expandSetString.has(item.idVirtual)">
              <ng-container *ngFor="let lv1 of item.childData,let i1=index">
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>{{lv1.tenChiCuc}}</td>
                  <td>{{lv1.tenCloaiVthh}}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>{{lv1.soLuongGiao}}</td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
                <ng-container *ngIf="expandSetString.has(item.idVirtual)">
                  <ng-container *ngFor="let lv2 of lv1.childData,let i2=index">
                    <tr>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td>{{lv2.tenDiemKho}}</td>
                      <td>{{lv2.tenLoKho}}</td>
                      <td>{{lv2.tongTichLuong}}</td>
                      <td>{{lv2.tonKho}}</td>
                      <td>{{lv2.soLuongXuat}}</td>
                      <td></td>
                      <td></td>
                      <td></td>
                    </tr>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
          </tbody>
        </nz-table>
      </div>
    </form>
  </nz-card>
</div>
